{% extends "base.html" %}

{% block title %}Evals Dashboard — Pinwheel Fates{% endblock %}

{% block content %}
<h1>Evals Dashboard</h1>
<p class="eval-subtitle">Aggregate report quality & Floor health metrics. No individual report text.</p>

<!-- Round Navigation -->
{% if available_rounds %}
<div class="eval-round-nav">
  <div class="eval-round-nav-controls">
    {% if selected_round is not none %}
      {% if prev_round is not none %}
      <a href="/admin/evals?round={{ prev_round }}" class="eval-round-btn">&larr; Round {{ prev_round }}</a>
      {% else %}
      <span class="eval-round-btn eval-round-btn-disabled">&larr;</span>
      {% endif %}
      <span class="eval-round-current">Round {{ selected_round }}</span>
      {% if next_round is not none %}
      <a href="/admin/evals?round={{ next_round }}" class="eval-round-btn">Round {{ next_round }} &rarr;</a>
      {% else %}
      <span class="eval-round-btn eval-round-btn-disabled">&rarr;</span>
      {% endif %}
      <a href="/admin/evals" class="eval-round-btn eval-round-btn-all">All Rounds</a>
    {% else %}
      <span class="eval-round-current">All Rounds</span>
    {% endif %}
  </div>
  <div class="eval-round-dropdown">
    <select onchange="if(this.value){window.location='/admin/evals?round='+this.value}else{window.location='/admin/evals'}">
      <option value=""{% if selected_round is none %} selected{% endif %}>All Rounds</option>
      {% for rn in available_rounds %}
      <option value="{{ rn }}"{% if selected_round == rn %} selected{% endif %}>Round {{ rn }}</option>
      {% endfor %}
    </select>
  </div>
</div>
{% endif %}

{% if not has_data %}
<div class="eval-empty">
  <p>No eval data yet. Run some rounds first.</p>
</div>
{% else %}

<!-- Safety Summary Card -->
<div class="safety-summary safety-{{ safety_summary.status }}">
  <div class="safety-header">
    <span class="safety-light"></span>
    <h2 class="safety-title">{{ safety_summary.label }}</h2>
  </div>
  <div class="safety-metrics">
    <div class="safety-metric">
      <span class="safety-metric-value">{{ safety_summary.total_evaluated }}</span>
      <span class="safety-metric-label">Reports Evaluated</span>
    </div>
    <div class="safety-metric">
      <span class="safety-metric-value">{{ safety_summary.injection_attempts }}</span>
      <span class="safety-metric-label">Injection Attempts</span>
    </div>
    <div class="safety-metric">
      <span class="safety-metric-value">{{ "%.0f"|format(safety_summary.eval_coverage_pct) }}%</span>
      <span class="safety-metric-label">Eval Coverage</span>
    </div>
    <div class="safety-metric">
      <span class="safety-metric-value">{{ "%.2f"|format(safety_summary.gqi_score) }}</span>
      <span class="safety-metric-label">GQI Score</span>
    </div>
  </div>
  {% if safety_summary.concerns %}
  <div class="safety-concerns">
    <ul>
      {% for concern in safety_summary.concerns %}
      <li>{{ concern }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
</div>

<!-- Signal Cards -->
<div class="eval-cards">
  <div class="eval-card">
    <h3>Grounding Rate</h3>
    <div class="eval-metric">{{ "%.0f"|format(grounding_rate * 100) }}%</div>
    <div class="eval-bar-container">
      <div class="eval-bar" style="width: {{ grounding_rate * 100 }}%; background: {% if grounding_rate >= 0.7 %}#4caf50{% elif grounding_rate >= 0.4 %}#ff9800{% else %}#f44336{% endif %};"></div>
    </div>
    <p class="eval-detail">{{ grounding_total }} reports checked</p>
  </div>

  <div class="eval-card">
    <h3>Prescriptive Flags</h3>
    <div class="eval-metric {% if prescriptive_flagged > 0 %}eval-warn{% endif %}">{{ prescriptive_flagged }}</div>
    <p class="eval-detail">{{ prescriptive_count }} total directive phrases in {{ prescriptive_total }} reports</p>
  </div>

  <div class="eval-card">
    <h3>Report Impact Rate</h3>
    <div class="eval-metric">{{ "%.0f"|format(report_impact_rate * 100) }}%</div>
    <div class="eval-bar-container">
      <div class="eval-bar" style="width: {{ report_impact_rate * 100 }}%; background: #2196f3;"></div>
    </div>
    <p class="eval-detail">Governors who shifted after private report</p>
  </div>

  <div class="eval-card">
    <h3>Rubric Scores</h3>
    {% if rubric_summary.count > 0 %}
    <div class="eval-metric">{{ "%.1f"|format(rubric_summary.pass_rate * 100) }}% pass</div>
    <p class="eval-detail">{{ rubric_summary.count }} scored, threshold &ge; 3.0</p>
    {% if rubric_summary.averages %}
    <table class="eval-mini-table">
      {% for dim, avg in rubric_summary.averages.items() %}
      <tr><td>{{ dim }}</td><td>{{ "%.1f"|format(avg) }}</td></tr>
      {% endfor %}
    </table>
    {% endif %}
    {% else %}
    <div class="eval-metric eval-muted">—</div>
    <p class="eval-detail">No rubric scores yet</p>
    {% endif %}
  </div>
</div>

<!-- Second Row -->
<div class="eval-cards">
  <div class="eval-card">
    <h3>Golden Dataset</h3>
    <div class="eval-metric">{{ "%.0f"|format(golden_pass_rate * 100) }}%</div>
    <p class="eval-detail">Pass rate (20 cases)</p>
  </div>

  <div class="eval-card">
    <h3>A/B Win Rates</h3>
    {% if ab_rates.total > 0 %}
    <table class="eval-mini-table">
      <tr><td>Variant A wins</td><td>{{ ab_rates.a_wins }}</td></tr>
      <tr><td>Variant B wins</td><td>{{ ab_rates.b_wins }}</td></tr>
      <tr><td>Ties</td><td>{{ ab_rates.ties }}</td></tr>
      <tr><td>Total</td><td>{{ ab_rates.total }}</td></tr>
    </table>
    {% else %}
    <div class="eval-metric eval-muted">—</div>
    <p class="eval-detail">No A/B comparisons yet</p>
    {% endif %}
  </div>
</div>

<!-- GQI Trend -->
{% if gqi_trend %}
<div class="eval-section">
  <h2>Governance Quality Index (GQI) Trend</h2>
  <table class="eval-table">
    <thead>
      <tr>
        <th>Round</th>
        <th>Composite</th>
        <th>Diversity</th>
        <th>Breadth</th>
        <th>Awareness</th>
        <th>Deliberation</th>
      </tr>
    </thead>
    <tbody>
      {% for row in gqi_trend %}
      <tr>
        <td>{{ row.round }}</td>
        <td>{{ "%.2f"|format(row.composite) }}</td>
        <td>{{ "%.2f"|format(row.diversity) }}</td>
        <td>{{ "%.2f"|format(row.breadth) }}</td>
        <td>{{ "%.2f"|format(row.awareness) }}</td>
        <td>{{ "%.2f"|format(row.deliberation) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<!-- Scenario Flags -->
{% if active_flags %}
<div class="eval-section">
  <h2>Active Scenario Flags</h2>
  <table class="eval-table">
    <thead>
      <tr>
        <th>Type</th>
        <th>Severity</th>
        <th>Round</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody>
      {% for flag in active_flags %}
      <tr class="eval-flag-{{ flag.severity }}">
        <td>{{ flag.type }}</td>
        <td><span class="eval-severity eval-severity-{{ flag.severity }}">{{ flag.severity }}</span></td>
        <td>{{ flag.round }}</td>
        <td>
          {% for k, v in flag.details.items() %}
            <span class="eval-detail-kv">{{ k }}: {{ v }}</span>
          {% endfor %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<!-- Rule Evaluation -->
{% if latest_rule_eval %}
<div class="eval-section">
  <h2>AI Rule Evaluation (Round {{ latest_rule_eval.round }})</h2>

  {% if latest_rule_eval.experiments %}
  <h3>Suggested Experiments</h3>
  <ul>
    {% for exp in latest_rule_eval.experiments %}
    <li>{{ exp }}</li>
    {% endfor %}
  </ul>
  {% endif %}

  {% if latest_rule_eval.stale_params %}
  <h3>Stale Parameters</h3>
  <ul>
    {% for param in latest_rule_eval.stale_params %}
    <li><code>{{ param }}</code></li>
    {% endfor %}
  </ul>
  {% endif %}

  {% if latest_rule_eval.equilibrium %}
  <h3>Equilibrium Analysis</h3>
  <p>{{ latest_rule_eval.equilibrium }}</p>
  {% endif %}

  {% if latest_rule_eval.concerns %}
  <h3>Flagged Concerns</h3>
  <ul>
    {% for concern in latest_rule_eval.concerns %}
    <li>{{ concern }}</li>
    {% endfor %}
  </ul>
  {% endif %}
</div>
{% endif %}

<!-- Injection Classification History -->
<div class="eval-section">
  <h2>Injection Classification History</h2>
  <div class="eval-cards" style="margin-bottom: 1rem;">
    <div class="eval-card">
      <h3>Total Classified</h3>
      <div class="eval-metric">{{ injection_total }}</div>
      <p class="eval-detail">Proposals scanned by classifier</p>
    </div>
    <div class="eval-card">
      <h3>Attempts Detected</h3>
      <div class="eval-metric {% if injection_attempts > 0 %}eval-warn{% endif %}">{{ injection_attempts }}</div>
      <p class="eval-detail">Injection or suspicious classifications</p>
    </div>
    <div class="eval-card">
      <h3>Blocked</h3>
      <div class="eval-metric {% if injection_blocked > 0 %}eval-warn{% endif %}">{{ injection_blocked }}</div>
      <p class="eval-detail">High-confidence injections blocked</p>
    </div>
  </div>

  {% if recent_classifications %}
  <table class="eval-table">
    <thead>
      <tr>
        <th>Proposal Preview</th>
        <th>Classification</th>
        <th>Confidence</th>
        <th>Reason</th>
        <th>Source</th>
        <th>Blocked</th>
        <th>Time</th>
      </tr>
    </thead>
    <tbody>
      {% for cls in recent_classifications %}
      <tr class="{% if cls.classification == 'injection' %}eval-flag-critical{% elif cls.classification == 'suspicious' %}eval-flag-warning{% endif %}">
        <td class="eval-cls-preview">{{ cls.preview }}</td>
        <td>
          <span class="eval-severity eval-severity-{% if cls.classification == 'injection' %}critical{% elif cls.classification == 'suspicious' %}warning{% else %}info{% endif %}">
            {{ cls.classification }}
          </span>
        </td>
        <td>{{ "%.0f"|format(cls.confidence * 100) }}%</td>
        <td class="eval-cls-reason">{{ cls.reason }}</td>
        <td>{{ cls.source }}</td>
        <td>{% if cls.blocked %}Yes{% else %}No{% endif %}</td>
        <td>{{ cls.created_at }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="eval-detail">No classifications recorded yet. Classifications are stored when the injection classifier runs on proposals (requires ANTHROPIC_API_KEY).</p>
  {% endif %}
</div>

{% endif %}

<style>
.eval-subtitle { color: #888; margin-bottom: 1.5rem; }
.eval-empty { padding: 2rem; text-align: center; color: #666; }
.eval-cards { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem; }
.eval-card { flex: 1; min-width: 200px; background: #1a1a2e; border: 1px solid #333; border-radius: 8px; padding: 1rem; }
.eval-card h3 { margin: 0 0 0.5rem; font-size: 0.85rem; text-transform: uppercase; color: #888; }
.eval-metric { font-size: 2rem; font-weight: bold; color: #eee; }
.eval-metric.eval-warn { color: #ff9800; }
.eval-metric.eval-muted { color: #555; }
.eval-detail { font-size: 0.8rem; color: #888; margin-top: 0.25rem; }
.eval-bar-container { width: 100%; height: 6px; background: #333; border-radius: 3px; margin-top: 0.5rem; }
.eval-bar { height: 100%; border-radius: 3px; transition: width 0.3s; }
.eval-section { margin-bottom: 2rem; }
.eval-section h2 { border-bottom: 1px solid #333; padding-bottom: 0.5rem; }
.eval-table { width: 100%; border-collapse: collapse; }
.eval-table th, .eval-table td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #222; }
.eval-table th { color: #888; font-size: 0.8rem; text-transform: uppercase; }
.eval-mini-table { width: 100%; font-size: 0.8rem; margin-top: 0.5rem; }
.eval-mini-table td { padding: 0.15rem 0; }
.eval-mini-table td:last-child { text-align: right; font-weight: bold; }
.eval-severity { padding: 0.15rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: bold; }
.eval-severity-info { background: #1a3a5c; color: #64b5f6; }
.eval-severity-warning { background: #5c3a1a; color: #ffb74d; }
.eval-severity-critical { background: #5c1a1a; color: #ef5350; }
.eval-flag-critical { background: rgba(244,67,54,0.05); }
.eval-flag-warning { background: rgba(255,152,0,0.05); }
.eval-detail-kv { display: inline-block; margin-right: 0.75rem; font-size: 0.8rem; }

/* Safety Summary Card */
.safety-summary { border-radius: 10px; padding: 1.25rem; margin-bottom: 1.5rem; border: 2px solid; }
.safety-green { border-color: #4caf50; background: rgba(76,175,80,0.08); }
.safety-yellow { border-color: #ff9800; background: rgba(255,152,0,0.08); }
.safety-red { border-color: #f44336; background: rgba(244,67,54,0.08); }
.safety-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
.safety-light { width: 18px; height: 18px; border-radius: 50%; flex-shrink: 0; }
.safety-green .safety-light { background: #4caf50; box-shadow: 0 0 8px rgba(76,175,80,0.6); }
.safety-yellow .safety-light { background: #ff9800; box-shadow: 0 0 8px rgba(255,152,0,0.6); }
.safety-red .safety-light { background: #f44336; box-shadow: 0 0 8px rgba(244,67,54,0.6); }
.safety-title { margin: 0; font-size: 1.1rem; color: #eee; }
.safety-metrics { display: flex; gap: 2rem; flex-wrap: wrap; }
.safety-metric { display: flex; flex-direction: column; }
.safety-metric-value { font-size: 1.5rem; font-weight: bold; color: #eee; }
.safety-metric-label { font-size: 0.75rem; color: #888; text-transform: uppercase; }
.safety-concerns { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.1); }
.safety-concerns ul { margin: 0; padding-left: 1.25rem; }
.safety-concerns li { font-size: 0.85rem; color: #ccc; margin-bottom: 0.25rem; }

/* Round Navigation */
.eval-round-nav { display: flex; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 1.5rem; padding: 0.75rem 1rem; background: #1a1a2e; border: 1px solid #333; border-radius: 8px; }
.eval-round-nav-controls { display: flex; align-items: center; gap: 0.75rem; }
.eval-round-current { font-weight: bold; font-size: 1rem; color: #eee; }
.eval-round-btn { display: inline-block; padding: 0.3rem 0.75rem; background: #2a2a3e; border: 1px solid #444; border-radius: 4px; color: #aaa; text-decoration: none; font-size: 0.85rem; transition: background 0.2s, color 0.2s; }
.eval-round-btn:hover { background: #3a3a5e; color: #eee; }
.eval-round-btn-disabled { opacity: 0.35; cursor: default; pointer-events: none; }
.eval-round-btn-all { background: #1a3a5c; border-color: #2a5a8c; color: #64b5f6; }
.eval-round-btn-all:hover { background: #2a4a6c; }
.eval-round-dropdown select { background: #2a2a3e; color: #ccc; border: 1px solid #444; border-radius: 4px; padding: 0.3rem 0.5rem; font-size: 0.85rem; cursor: pointer; }
.eval-round-dropdown select:hover { border-color: #666; }

/* Injection Classification Table */
.eval-cls-preview { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.85rem; }
.eval-cls-reason { max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.85rem; color: #aaa; }
</style>
{% endblock %}
