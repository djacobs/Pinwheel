{% extends "base.html" %}
{% block title %}{{ home_name }} vs {{ away_name }} â€” Pinwheel Fates{% endblock %}

{% block content %}
<div class="game-header card mb-2">
  {% if game_phase == 'finals' %}
  <div style="text-align:center; padding: 0.5rem 0; color: var(--accent-score); font-weight: 800; font-size: 0.85rem; letter-spacing: 0.15em; text-transform: uppercase;">CHAMPIONSHIP FINALS</div>
  {% elif game_phase == 'semifinal' %}
  <div style="text-align:center; padding: 0.5rem 0; color: var(--accent-elam); font-weight: 800; font-size: 0.85rem; letter-spacing: 0.15em; text-transform: uppercase;">SEMIFINAL PLAYOFFS</div>
  {% endif %}
  <div class="game-matchup">
    <div class="game-team" style="background: {{ home_color2 }}; border-left: 4px solid {{ home_color }}; padding: 1rem; border-radius: var(--radius);">
      <div class="game-team-name {% if game.winner_team_id == game.home_team_id %}score-winner{% endif %}" style="color: {{ home_color }};">
        {{ home_name }}
      </div>
      <div class="game-team-score">{{ game.home_score }}</div>
    </div>
    <div style="text-align:center;">
      <div class="game-status final">FINAL</div>
      {% if game.elam_target %}
      <div class="text-xs mt-1" style="color: var(--accent-elam);">
        ELAM TARGET: {{ game.elam_target }}
      </div>
      {% endif %}
    </div>
    <div class="game-team" style="background: {{ away_color2 }}; border-left: 4px solid {{ away_color }}; padding: 1rem; border-radius: var(--radius);">
      <div class="game-team-name {% if game.winner_team_id == game.away_team_id %}score-winner{% endif %}" style="color: {{ away_color }};">
        {{ away_name }}
      </div>
      <div class="game-team-score">{{ game.away_score }}</div>
    </div>
  </div>

  {% if game.quarter_scores %}
  <div class="flex justify-between mt-1" style="max-width:400px; margin-left:auto; margin-right:auto;">
    <table class="quarter-table">
      <thead>
        <tr>
          <th></th>
          {% for qs in game.quarter_scores %}
          <th>Q{{ loop.index }}</th>
          {% endfor %}
          <th>T</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="qt-team">{{ home_name[:3]|upper }}</td>
          {% for qs in game.quarter_scores %}
          <td class="{% if qs.home_score > qs.away_score %}qt-bold{% endif %}">{{ qs.home_score if qs.home_score is defined else qs['home_score'] }}</td>
          {% endfor %}
          <td class="qt-total {% if game.winner_team_id == game.home_team_id %}qt-bold{% endif %}">{{ game.home_score }}</td>
        </tr>
        <tr>
          <td class="qt-team">{{ away_name[:3]|upper }}</td>
          {% for qs in game.quarter_scores %}
          <td class="{% if qs.away_score > qs.home_score %}qt-bold{% endif %}">{{ qs.away_score if qs.away_score is defined else qs['away_score'] }}</td>
          {% endfor %}
          <td class="qt-total {% if game.winner_team_id == game.away_team_id %}qt-bold{% endif %}">{{ game.away_score }}</td>
        </tr>
      </tbody>
    </table>
  </div>
  {% endif %}
</div>

<div class="game-detail-grid">
  <!-- Box Score -->
  <div class="card">
    <div class="card-header">
      <h3>Box Score</h3>
    </div>
    <div class="card-body" style="padding:0;">
      <table class="box-score-table">
        <thead>
          <tr>
            <th>Player</th>
            <th>PTS</th>
            <th>FG</th>
            <th>3P</th>
            <th>AST</th>
            <th>STL</th>
            <th>TO</th>
          </tr>
        </thead>
        <tbody>
          {% for team_name, team_id, players, team_color in box_score_groups %}
          <tr class="team-header">
            <td colspan="7" style="border-left: 3px solid {{ team_color }}; padding-left: 0.5rem;">{{ team_name }}</td>
          </tr>
          {% for p in players %}
          <tr>
            <td><a href="/hoopers/{{ p.hooper_id }}" style="color:inherit; text-decoration:underline dotted;">{{ p.hooper_name }}</a></td>
            <td>{{ p.points }}</td>
            <td>{{ p.field_goals_made }}-{{ p.field_goals_attempted }}</td>
            <td>{{ p.three_pointers_made }}-{{ p.three_pointers_attempted }}</td>
            <td>{{ p.assists }}</td>
            <td>{{ p.steals }}</td>
            <td>{{ p.turnovers }}</td>
          </tr>
          {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Play-by-Play -->
  <div class="card">
    <div class="card-header">
      <h3>Play-by-Play</h3>
      <span class="text-xs text-muted">{{ game.total_possessions }} possessions</span>
    </div>
    <div class="card-body" style="padding:0; max-height:500px; overflow-y:auto;">
      {% if play_by_play %}
      <ul class="pbp-list">
        {% for play in play_by_play %}
        <li class="pbp-item" {% if play.handler_id %}data-handler="{{ play.handler_id }}"{% endif %}>
          <span class="pbp-quarter">Q{{ play.quarter }}{% if play.game_clock %} {{ play.game_clock }}{% endif %}</span>
          <span class="pbp-action">{{ play.narration }}</span>
          {% if play.points_scored > 0 %}
          <span class="pbp-points">+{{ play.points_scored }}</span>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="empty-state" style="padding:1.5rem;">
        <p class="text-muted">Play-by-play data not available.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

{% if report %}
<div class="report-card mt-2">
  <div class="report-type">Simulation Report</div>
  <div class="report-content">{{ report.content }}</div>
</div>
{% endif %}

<div class="mt-2">
  <a href="/arena" class="nav-link">&larr; Back to Arena</a>
</div>

<script>
document.querySelectorAll('.pbp-item[data-handler]').forEach(function(el) {
  el.style.cursor = 'pointer';
  el.addEventListener('click', function() {
    window.location.href = '/hoopers/' + el.dataset.handler;
  });
});
</script>
{% endblock %}
