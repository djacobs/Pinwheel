{% extends "base.html" %}
{% block title %}Arena — Pinwheel Fates{% endblock %}

{% block content %}
<div class="page-header">
  <h2>The Arena</h2>
  {% if rounds %}
  <p class="subtitle">{{ rounds|length }} round{{ 's' if rounds|length != 1 else '' }} &middot; {{ rounds|sum(attribute='games'|length) if false else rounds|map(attribute='games')|map('length')|sum }} games</p>
  {% endif %}
</div>

<!-- Live Games — server-rendered if a presentation is active, else hidden for SSE -->
{% if live_round %}
<div class="section-title">Live — Round {{ live_round.round_number }}</div>
<div id="live-container" class="live-container">
  {% for game in live_round.games %}
  <div class="live-zone" id="live-game-{{ game.game_index }}">
    <div class="live-zone-header">
      <span class="live-badge {% if game.status == 'final' %}live-badge-done{% endif %}">{{ 'FINAL' if game.status == 'final' else 'LIVE' }}</span>
      <span class="live-quarter" data-g="{{ game.game_index }}">Q{{ game.quarter }}</span>
      <span class="live-clock" data-g="{{ game.game_index }}">{{ game.game_clock }}</span>
    </div>
    <div class="live-zone-scoreboard">
      <div class="live-team">
        <span class="live-team-name" data-role="home" data-g="{{ game.game_index }}" style="color: {{ game.home_color }};">{{ game.home_team_name }}</span>
        <span class="live-score" data-role="home" data-g="{{ game.game_index }}">{{ game.home_score }}</span>
      </div>
      <div class="live-vs">vs</div>
      <div class="live-team">
        <span class="live-team-name" data-role="away" data-g="{{ game.game_index }}" style="color: {{ game.away_color }};">{{ game.away_team_name }}</span>
        <span class="live-score" data-role="away" data-g="{{ game.game_index }}">{{ game.away_score }}</span>
      </div>
    </div>
    {% if game.home_leader or game.away_leader %}
    <div class="live-leaders" data-g="{{ game.game_index }}">
      {% if game.home_leader %}
      <span class="live-leader"><a href="/hoopers/{{ game.home_leader.hooper_id }}">{{ game.home_leader.hooper_name }}</a> {{ game.home_leader.points }} pts</span>
      {% endif %}
      {% if game.away_leader %}
      <span class="live-leader"><a href="/hoopers/{{ game.away_leader.hooper_id }}">{{ game.away_leader.hooper_name }}</a> {{ game.away_leader.points }} pts</span>
      {% endif %}
    </div>
    {% else %}
    <div class="live-leaders" data-g="{{ game.game_index }}"></div>
    {% endif %}
    <div class="live-status" data-g="{{ game.game_index }}" {% if game.status == 'final' %}class="live-status live-final"{% endif %}>{% if game.status == 'final' %}FINAL{% endif %}</div>
    <div class="live-plays" data-g="{{ game.game_index }}">
      {% for play in game.recent_plays|reverse %}
      <div class="live-play-line" style="color: {{ play.offense_color }};">
        <span class="live-play-clock">{{ play.game_clock }}</span>
        {{ play.narration }}
        {% if play.points_scored > 0 %}<span class="live-play-pts">+{{ play.points_scored }}</span>{% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div id="live-container" class="live-container" style="display:none;"></div>
{% endif %}

<!-- Advance Round button — visible when auto_advance is off -->
{% if not auto_advance %}
<div style="margin-bottom:1rem;">
  <button id="advance-btn" class="advance-btn" onclick="advanceRound()">Advance Round</button>
  <span id="advance-status" style="margin-left:0.5rem; color:var(--text-muted); font-size:0.85rem;"></span>
</div>
{% endif %}

{% if rounds %}
<div>
  {% for round in rounds %}
  <div class="{% if not loop.first %}mt-2{% endif %}">
    <div class="section-title">Round {{ round.round_number }}</div>
    <div class="arena-grid">
      {% for game in round.games %}
      <a href="/games/{{ game.id }}" class="game-panel {% if game.elam_target %}elam{% endif %}" style="text-decoration:none; color:inherit;">
        {% if game.winning_play %}
        <div class="elam-banner">{{ game.winning_play.action }}</div>
        {% elif game.elam_target %}
        <div class="elam-banner">Elam Ending &mdash; Target: {{ game.elam_target }}</div>
        {% endif %}
        <div class="game-panel-header">
          <span class="game-meta">Game {{ game.matchup_index + 1 }}</span>
          <span class="game-meta">{{ game.total_possessions }} poss</span>
        </div>
        <div class="game-panel-teams">
          <div class="team-score-block" style="border-left: 3px solid {{ game.home_color }}; padding-left: 0.5rem;">
            <div class="team-name {% if game.winner_team_id == game.home_team_id %}winner{% endif %}" {% if game.winner_team_id == game.home_team_id %}style="color: {{ game.home_color }};"{% endif %}>
              {{ game.home_name }}
            </div>
            <div class="score score-sm {% if game.winner_team_id == game.home_team_id %}score-winner{% else %}score-loser{% endif %}">
              {{ game.home_score }}
            </div>
          </div>
          <div class="vs-divider">Final</div>
          <div class="team-score-block" style="border-left: 3px solid {{ game.away_color }}; padding-left: 0.5rem;">
            <div class="team-name {% if game.winner_team_id == game.away_team_id %}winner{% endif %}" {% if game.winner_team_id == game.away_team_id %}style="color: {{ game.away_color }};"{% endif %}>
              {{ game.away_name }}
            </div>
            <div class="score score-sm {% if game.winner_team_id == game.away_team_id %}score-winner{% else %}score-loser{% endif %}">
              {{ game.away_score }}
            </div>
          </div>
        </div>
        {% if game.quarter_scores %}
        <table class="quarter-table">
          <thead>
            <tr>
              <th></th>
              {% for qs in game.quarter_scores %}
              <th>Q{{ loop.index }}</th>
              {% endfor %}
              <th>T</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="qt-team">{{ game.home_name[:3] | upper }}</td>
              {% for qs in game.quarter_scores %}
              <td class="{% if qs.home_score > qs.away_score %}qt-bold{% endif %}">{{ qs.home_score }}</td>
              {% endfor %}
              <td class="qt-total {% if game.winner_team_id == game.home_team_id %}qt-bold{% endif %}">{{ game.home_score }}</td>
            </tr>
            <tr>
              <td class="qt-team">{{ game.away_name[:3] | upper }}</td>
              {% for qs in game.quarter_scores %}
              <td class="{% if qs.away_score > qs.home_score %}qt-bold{% endif %}">{{ qs.away_score }}</td>
              {% endfor %}
              <td class="qt-total {% if game.winner_team_id == game.away_team_id %}qt-bold{% endif %}">{{ game.away_score }}</td>
            </tr>
          </tbody>
        </table>
        {% endif %}
      </a>
      {% endfor %}
    </div>

    {% if round.report %}
    <div class="report-card mt-1">
      <div class="report-type">Simulation Report &mdash; Round {{ round.report.round_number }}</div>
      <div class="report-content">{{ round.report.content }}</div>
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>

{% else %}
{% if not live_round %}
<div class="empty-state">
  <h3>No Games Yet</h3>
  <p>The season hasn't started. Games will appear here once the first round is simulated.</p>
</div>
{% endif %}
{% endif %}

{% if upcoming_games %}
<div class="mt-2">
  <div class="section-title">Up Next</div>
  <div class="arena-grid">
    {% for ug in upcoming_games %}
    <div class="game-panel upcoming-panel">
      <div class="game-panel-teams">
        <div class="team-score-block" style="border-left: 3px solid {{ ug.home_color }}; padding-left: 0.5rem;">
          <div class="team-name">{{ ug.home_name }}</div>
        </div>
        <div class="vs-divider">vs</div>
        <div class="team-score-block" style="border-left: 3px solid {{ ug.away_color }}; padding-left: 0.5rem;">
          <div class="team-name">{{ ug.away_name }}</div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<script>
(function() {
  var es = new EventSource('/api/events/stream');
  var container = document.getElementById('live-container');
  var maxPlays = 30;

  es.onopen = function() { console.log('[SSE] connected'); };
  es.onerror = function(e) { console.error('[SSE] error', e); };

  function getOrCreateZone(gameIdx, d) {
    var zoneId = 'live-game-' + gameIdx;
    var zone = document.getElementById(zoneId);
    if (zone) return zone;
    container.style.display = '';
    var homeColor = d.home_team_color || '#888';
    var awayColor = d.away_team_color || '#888';
    zone = document.createElement('div');
    zone.id = zoneId;
    zone.className = 'live-zone';
    zone.innerHTML =
      '<div class="live-zone-header">' +
        '<span class="live-badge">LIVE</span>' +
        '<span class="live-quarter" data-g="' + gameIdx + '">Q1</span>' +
        '<span class="live-clock" data-g="' + gameIdx + '"></span>' +
      '</div>' +
      '<div class="live-zone-scoreboard">' +
        '<div class="live-team">' +
          '<span class="live-team-name" data-role="home" data-g="' + gameIdx + '" style="color:' + homeColor + ';">' + (d.home_team_name || 'Home') + '</span>' +
          '<span class="live-score" data-role="home" data-g="' + gameIdx + '">0</span>' +
        '</div>' +
        '<div class="live-vs">vs</div>' +
        '<div class="live-team">' +
          '<span class="live-team-name" data-role="away" data-g="' + gameIdx + '" style="color:' + awayColor + ';">' + (d.away_team_name || 'Away') + '</span>' +
          '<span class="live-score" data-role="away" data-g="' + gameIdx + '">0</span>' +
        '</div>' +
      '</div>' +
      '<div class="live-leaders" data-g="' + gameIdx + '"></div>' +
      '<div class="live-status" data-g="' + gameIdx + '"></div>' +
      '<div class="live-plays" data-g="' + gameIdx + '"></div>';
    container.appendChild(zone);
    return zone;
  }

  function q(sel) { return document.querySelector(sel); }

  es.addEventListener('presentation.game_starting', function(e) {
    var d = JSON.parse(e.data).data;
    getOrCreateZone(d.game_index, d);
    var btn = document.getElementById('advance-btn');
    if (btn) btn.disabled = true;
  });

  es.addEventListener('presentation.possession', function(e) {
    var d = JSON.parse(e.data).data;
    var gi = d.game_index;
    var homeScore = q('.live-score[data-role="home"][data-g="' + gi + '"]');
    var awayScore = q('.live-score[data-role="away"][data-g="' + gi + '"]');
    var quarter = q('.live-quarter[data-g="' + gi + '"]');
    var clock = q('.live-clock[data-g="' + gi + '"]');
    var plays = q('.live-plays[data-g="' + gi + '"]');
    if (homeScore) homeScore.textContent = d.home_score;
    if (awayScore) awayScore.textContent = d.away_score;
    if (quarter) quarter.textContent = 'Q' + d.quarter;
    if (clock) {
      if (d.game_clock) clock.textContent = d.game_clock;
      else if (d.elam_target) clock.textContent = 'Target score: ' + d.elam_target;
    }
    if (plays && d.narration) {
      var line = document.createElement('div');
      line.className = 'live-play-line';
      if (d.offense_color) line.style.color = d.offense_color;
      var pts = d.points_scored > 0 ? ' <span class="live-play-pts">+' + d.points_scored + '</span>' : '';
      line.innerHTML = '<span class="live-play-clock">' + (d.game_clock || '') + '</span> ' + d.narration + pts;
      plays.insertBefore(line, plays.firstChild);
      while (plays.children.length > maxPlays) plays.removeChild(plays.lastChild);
    }
  });

  es.addEventListener('presentation.game_finished', function(e) {
    var d = JSON.parse(e.data).data;
    var gi = d.game_index;
    var homeScore = q('.live-score[data-role="home"][data-g="' + gi + '"]');
    var awayScore = q('.live-score[data-role="away"][data-g="' + gi + '"]');
    var status = q('.live-status[data-g="' + gi + '"]');
    if (homeScore) homeScore.textContent = d.home_score;
    if (awayScore) awayScore.textContent = d.away_score;
    if (status) { status.textContent = 'FINAL'; status.className = 'live-status live-final'; }
    var badge = document.querySelector('#live-game-' + gi + ' .live-badge');
    if (badge) { badge.textContent = 'FINAL'; badge.className = 'live-badge live-badge-done'; }
    // Show leaders
    var leaders = q('.live-leaders[data-g="' + gi + '"]');
    if (leaders) {
      var parts = [];
      if (d.home_leader) parts.push('<span class="live-leader"><a href="/hoopers/' + d.home_leader.hooper_id + '">' + d.home_leader.hooper_name + '</a> ' + d.home_leader.points + ' pts</span>');
      if (d.away_leader) parts.push('<span class="live-leader"><a href="/hoopers/' + d.away_leader.hooper_id + '">' + d.away_leader.hooper_name + '</a> ' + d.away_leader.points + ' pts</span>');
      leaders.innerHTML = parts.join('');
    }
  });

  es.addEventListener('presentation.round_finished', function(e) {
    setTimeout(function() { window.location.reload(); }, 3000);
  });
})();

function advanceRound() {
  var btn = document.getElementById('advance-btn');
  var status = document.getElementById('advance-status');
  btn.disabled = true;
  status.textContent = 'Starting...';
  fetch('/api/pace/advance', { method: 'POST' })
    .then(function(r) {
      if (r.status === 409) { status.textContent = 'Already running'; btn.disabled = false; return; }
      if (!r.ok) { status.textContent = 'Error: ' + r.status; btn.disabled = false; return; }
      status.textContent = 'Round advancing\u2026';
    })
    .catch(function() { status.textContent = 'Failed'; btn.disabled = false; });
}
</script>
{% endblock %}
