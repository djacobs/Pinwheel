{% extends "base.html" %}
{% block title %}Arena — Pinwheel Fates{% endblock %}

{% block content %}
<div class="page-header">
  <h2>The Arena</h2>
  {% if rounds %}
  <p class="subtitle">{{ rounds|length }} round{{ 's' if rounds|length != 1 else '' }} &middot; {{ rounds|sum(attribute='games'|length) if false else rounds|map(attribute='games')|map('length')|sum }} games</p>
  {% endif %}
</div>

<!-- Live Games Container — populated dynamically when presentation starts -->
<div id="live-container" class="live-container" style="display:none;"></div>

<!-- Advance Round button — visible when auto_advance is off -->
{% if not auto_advance %}
<div style="margin-bottom:1rem;">
  <button id="advance-btn" class="advance-btn" onclick="advanceRound()">Advance Round</button>
  <span id="advance-status" style="margin-left:0.5rem; color:var(--text-muted); font-size:0.85rem;"></span>
</div>
{% endif %}

{% if rounds %}
<div hx-ext="sse" sse-connect="/api/events/stream">
  {% for round in rounds %}
  <div class="{% if not loop.first %}mt-2{% endif %}">
    <div class="section-title">Round {{ round.round_number }}</div>
    <div class="arena-grid">
      {% for game in round.games %}
      <a href="/games/{{ game.id }}" class="game-panel {% if game.elam_target %}elam{% endif %}" style="text-decoration:none; color:inherit;">
        {% if game.winning_play %}
        <div class="elam-banner">{{ game.winning_play.action }}</div>
        {% elif game.elam_target %}
        <div class="elam-banner">Elam Ending &mdash; Target: {{ game.elam_target }}</div>
        {% endif %}
        <div class="game-panel-header">
          <span class="game-meta">Game {{ game.matchup_index + 1 }}</span>
          <span class="game-meta">{{ game.total_possessions }} poss</span>
        </div>
        <div class="game-panel-teams">
          <div class="team-score-block">
            <div class="team-name {% if game.winner_team_id == game.home_team_id %}winner{% endif %}">
              {{ game.home_name }}
            </div>
            <div class="score score-sm {% if game.winner_team_id == game.home_team_id %}score-winner{% else %}score-loser{% endif %}">
              {{ game.home_score }}
            </div>
          </div>
          <div class="vs-divider">Final</div>
          <div class="team-score-block">
            <div class="team-name {% if game.winner_team_id == game.away_team_id %}winner{% endif %}">
              {{ game.away_name }}
            </div>
            <div class="score score-sm {% if game.winner_team_id == game.away_team_id %}score-winner{% else %}score-loser{% endif %}">
              {{ game.away_score }}
            </div>
          </div>
        </div>
        {% if game.quarter_scores %}
        <table class="quarter-table">
          <thead>
            <tr>
              <th></th>
              {% for qs in game.quarter_scores %}
              <th>Q{{ loop.index }}</th>
              {% endfor %}
              <th>T</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="qt-team">{{ game.home_name[:3] | upper }}</td>
              {% for qs in game.quarter_scores %}
              <td class="{% if qs.home_score > qs.away_score %}qt-bold{% endif %}">{{ qs.home_score }}</td>
              {% endfor %}
              <td class="qt-total {% if game.winner_team_id == game.home_team_id %}qt-bold{% endif %}">{{ game.home_score }}</td>
            </tr>
            <tr>
              <td class="qt-team">{{ game.away_name[:3] | upper }}</td>
              {% for qs in game.quarter_scores %}
              <td class="{% if qs.away_score > qs.home_score %}qt-bold{% endif %}">{{ qs.away_score }}</td>
              {% endfor %}
              <td class="qt-total {% if game.winner_team_id == game.away_team_id %}qt-bold{% endif %}">{{ game.away_score }}</td>
            </tr>
          </tbody>
        </table>
        {% endif %}
      </a>
      {% endfor %}
    </div>

    {% if round.mirror %}
    <div class="mirror-card mt-1">
      <div class="mirror-type">Simulation Mirror &mdash; Round {{ round.mirror.round_number }}</div>
      <div class="mirror-content">{{ round.mirror.content }}</div>
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>

{% else %}
<div class="empty-state">
  <h3>No Games Yet</h3>
  <p>The season hasn't started. Games will appear here once the first round is simulated.</p>
</div>
{% endif %}

<script>
(function() {
  var es = new EventSource('/api/events/stream');
  var container = document.getElementById('live-container');
  var maxPlays = 30;

  function getOrCreateZone(gameIdx, d) {
    var zoneId = 'live-game-' + gameIdx;
    var zone = document.getElementById(zoneId);
    if (zone) return zone;
    container.style.display = '';
    zone = document.createElement('div');
    zone.id = zoneId;
    zone.className = 'live-zone';
    zone.innerHTML =
      '<div class="live-zone-header">' +
        '<span class="live-badge">LIVE</span>' +
        '<span class="live-quarter" data-g="' + gameIdx + '">Q1</span>' +
        '<span class="live-clock" data-g="' + gameIdx + '"></span>' +
      '</div>' +
      '<div class="live-zone-scoreboard">' +
        '<div class="live-team">' +
          '<span class="live-team-name" data-role="home" data-g="' + gameIdx + '">' + (d.home_team_name || 'Home') + '</span>' +
          '<span class="live-score" data-role="home" data-g="' + gameIdx + '">0</span>' +
        '</div>' +
        '<div class="live-vs">vs</div>' +
        '<div class="live-team">' +
          '<span class="live-team-name" data-role="away" data-g="' + gameIdx + '">' + (d.away_team_name || 'Away') + '</span>' +
          '<span class="live-score" data-role="away" data-g="' + gameIdx + '">0</span>' +
        '</div>' +
      '</div>' +
      '<div class="live-status" data-g="' + gameIdx + '"></div>' +
      '<div class="live-plays" data-g="' + gameIdx + '"></div>';
    container.appendChild(zone);
    return zone;
  }

  function q(sel) { return document.querySelector(sel); }

  es.addEventListener('presentation.game_starting', function(e) {
    var d = JSON.parse(e.data).data;
    getOrCreateZone(d.game_index, d);
    var btn = document.getElementById('advance-btn');
    if (btn) btn.disabled = true;
  });

  es.addEventListener('presentation.possession', function(e) {
    var d = JSON.parse(e.data).data;
    var gi = d.game_index;
    var homeScore = q('.live-score[data-role="home"][data-g="' + gi + '"]');
    var awayScore = q('.live-score[data-role="away"][data-g="' + gi + '"]');
    var quarter = q('.live-quarter[data-g="' + gi + '"]');
    var clock = q('.live-clock[data-g="' + gi + '"]');
    var plays = q('.live-plays[data-g="' + gi + '"]');
    if (homeScore) homeScore.textContent = d.home_score;
    if (awayScore) awayScore.textContent = d.away_score;
    if (quarter) quarter.textContent = 'Q' + d.quarter;
    if (clock && d.game_clock) clock.textContent = d.game_clock;
    if (plays && d.narration) {
      var line = document.createElement('div');
      line.className = 'live-play-line';
      var pts = d.points_scored > 0 ? ' <span class="live-play-pts">+' + d.points_scored + '</span>' : '';
      line.innerHTML = '<span class="live-play-clock">' + (d.game_clock || '') + '</span> ' + d.narration + pts;
      plays.insertBefore(line, plays.firstChild);
      while (plays.children.length > maxPlays) plays.removeChild(plays.lastChild);
    }
  });

  es.addEventListener('presentation.game_finished', function(e) {
    var d = JSON.parse(e.data).data;
    var gi = d.game_index;
    var homeScore = q('.live-score[data-role="home"][data-g="' + gi + '"]');
    var awayScore = q('.live-score[data-role="away"][data-g="' + gi + '"]');
    var status = q('.live-status[data-g="' + gi + '"]');
    if (homeScore) homeScore.textContent = d.home_score;
    if (awayScore) awayScore.textContent = d.away_score;
    if (status) { status.textContent = 'FINAL'; status.className = 'live-status live-final'; }
    var badge = document.querySelector('#live-game-' + gi + ' .live-badge');
    if (badge) { badge.textContent = 'DONE'; badge.className = 'live-badge live-badge-done'; }
  });

  es.addEventListener('presentation.round_finished', function(e) {
    setTimeout(function() { window.location.reload(); }, 3000);
  });
})();

function advanceRound() {
  var btn = document.getElementById('advance-btn');
  var status = document.getElementById('advance-status');
  btn.disabled = true;
  status.textContent = 'Starting...';
  fetch('/api/pace/advance', { method: 'POST' })
    .then(function(r) {
      if (r.status === 409) { status.textContent = 'Already running'; btn.disabled = false; return; }
      if (!r.ok) { status.textContent = 'Error: ' + r.status; btn.disabled = false; return; }
      status.textContent = 'Games are live!';
    })
    .catch(function() { status.textContent = 'Failed'; btn.disabled = false; });
}
</script>
{% endblock %}
