{% extends "base.html" %}
{% block title %}Arena — Pinwheel Fates{% endblock %}

{% block content %}
<div class="page-header">
  <h2>The Arena</h2>
  {% if rounds %}
  <p class="subtitle">{{ rounds|length }} round{{ 's' if rounds|length != 1 else '' }} &middot; {{ rounds|sum(attribute='games'|length) if false else rounds|map(attribute='games')|map('length')|sum }} games</p>
  {% endif %}
</div>

<!-- Live Zone — hidden until presentation starts -->
<div id="live-zone" class="live-zone" style="display:none;">
  <div class="live-zone-header">
    <span class="live-badge">LIVE</span>
    <span id="live-game-label" class="live-game-label">Game 1 of 2</span>
    <span id="live-quarter" class="live-quarter">Q1</span>
    <span id="live-clock" class="live-clock"></span>
  </div>
  <div class="live-zone-scoreboard">
    <div class="live-team">
      <span id="live-home-name" class="live-team-name">Home</span>
      <span id="live-home-score" class="live-score">0</span>
    </div>
    <div class="live-vs">vs</div>
    <div class="live-team">
      <span id="live-away-name" class="live-team-name">Away</span>
      <span id="live-away-score" class="live-score">0</span>
    </div>
  </div>
  <div id="live-status" class="live-status"></div>
  <div id="live-plays" class="live-plays"></div>
</div>

<!-- Advance Round button (dev/staging) -->
{% if pinwheel_env != 'production' %}
<div style="margin-bottom:1rem;">
  <button id="advance-btn" class="advance-btn" onclick="advanceRound()">Advance Round</button>
  <span id="advance-status" style="margin-left:0.5rem; color:var(--text-muted); font-size:0.85rem;"></span>
</div>
{% endif %}

{% if rounds %}
<div hx-ext="sse" sse-connect="/api/events/stream">
  {% for round in rounds %}
  <div class="{% if not loop.first %}mt-2{% endif %}">
    <div class="section-title">Round {{ round.round_number }}</div>
    <div class="arena-grid">
      {% for game in round.games %}
      <a href="/games/{{ game.id }}" class="game-panel {% if game.elam_target %}elam{% endif %}" style="text-decoration:none; color:inherit;">
        {% if game.winning_play %}
        <div class="elam-banner">{{ game.winning_play.action }}</div>
        {% elif game.elam_target %}
        <div class="elam-banner">Elam Ending &mdash; Target: {{ game.elam_target }}</div>
        {% endif %}
        <div class="game-panel-header">
          <span class="game-meta">Game {{ game.matchup_index + 1 }}</span>
          <span class="game-meta">{{ game.total_possessions }} poss</span>
        </div>
        <div class="game-panel-teams">
          <div class="team-score-block">
            <div class="team-name {% if game.winner_team_id == game.home_team_id %}winner{% endif %}">
              {{ game.home_name }}
            </div>
            <div class="score score-sm {% if game.winner_team_id == game.home_team_id %}score-winner{% else %}score-loser{% endif %}">
              {{ game.home_score }}
            </div>
          </div>
          <div class="vs-divider">Final</div>
          <div class="team-score-block">
            <div class="team-name {% if game.winner_team_id == game.away_team_id %}winner{% endif %}">
              {{ game.away_name }}
            </div>
            <div class="score score-sm {% if game.winner_team_id == game.away_team_id %}score-winner{% else %}score-loser{% endif %}">
              {{ game.away_score }}
            </div>
          </div>
        </div>
        {% if game.quarter_scores %}
        <table class="quarter-table">
          <thead>
            <tr>
              <th></th>
              {% for qs in game.quarter_scores %}
              <th>Q{{ loop.index }}</th>
              {% endfor %}
              <th>T</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="qt-team">{{ game.home_name[:3] | upper }}</td>
              {% for qs in game.quarter_scores %}
              <td class="{% if qs.home_score > qs.away_score %}qt-bold{% endif %}">{{ qs.home_score }}</td>
              {% endfor %}
              <td class="qt-total {% if game.winner_team_id == game.home_team_id %}qt-bold{% endif %}">{{ game.home_score }}</td>
            </tr>
            <tr>
              <td class="qt-team">{{ game.away_name[:3] | upper }}</td>
              {% for qs in game.quarter_scores %}
              <td class="{% if qs.away_score > qs.home_score %}qt-bold{% endif %}">{{ qs.away_score }}</td>
              {% endfor %}
              <td class="qt-total {% if game.winner_team_id == game.away_team_id %}qt-bold{% endif %}">{{ game.away_score }}</td>
            </tr>
          </tbody>
        </table>
        {% endif %}
      </a>
      {% endfor %}
    </div>

    {% if round.mirror %}
    <div class="mirror-card mt-1">
      <div class="mirror-type">Simulation Mirror &mdash; Round {{ round.mirror.round_number }}</div>
      <div class="mirror-content">{{ round.mirror.content }}</div>
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>

{% else %}
<div class="empty-state">
  <h3>No Games Yet</h3>
  <p>The season hasn't started. Games will appear here once the first round is simulated.</p>
</div>
{% endif %}

<script>
(function() {
  var es = new EventSource('/api/events/stream');
  var liveZone = document.getElementById('live-zone');
  var livePlays = document.getElementById('live-plays');
  var maxPlays = 20;

  es.addEventListener('presentation.game_starting', function(e) {
    var d = JSON.parse(e.data).data;
    liveZone.style.display = '';
    document.getElementById('live-home-name').textContent = d.home_team_name || d.home_team_id;
    document.getElementById('live-away-name').textContent = d.away_team_name || d.away_team_id;
    document.getElementById('live-home-score').textContent = '0';
    document.getElementById('live-away-score').textContent = '0';
    document.getElementById('live-quarter').textContent = 'Q1';
    document.getElementById('live-clock').textContent = '';
    document.getElementById('live-game-label').textContent =
      'Game ' + (d.game_index + 1) + ' of ' + d.total_games;
    document.getElementById('live-status').textContent = '';
    livePlays.innerHTML = '';
    var btn = document.getElementById('advance-btn');
    if (btn) btn.disabled = true;
  });

  es.addEventListener('presentation.possession', function(e) {
    var d = JSON.parse(e.data).data;
    document.getElementById('live-home-score').textContent = d.home_score;
    document.getElementById('live-away-score').textContent = d.away_score;
    document.getElementById('live-quarter').textContent = 'Q' + d.quarter;
    if (d.game_clock) {
      document.getElementById('live-clock').textContent = d.game_clock;
    }
    if (d.narration) {
      var line = document.createElement('div');
      line.className = 'live-play-line';
      var pts = d.points_scored > 0 ? ' <span class="live-play-pts">+' + d.points_scored + '</span>' : '';
      line.innerHTML = '<span class="live-play-clock">' + (d.game_clock || '') + '</span> ' + d.narration + pts;
      livePlays.insertBefore(line, livePlays.firstChild);
      while (livePlays.children.length > maxPlays) {
        livePlays.removeChild(livePlays.lastChild);
      }
    }
  });

  es.addEventListener('presentation.game_finished', function(e) {
    var d = JSON.parse(e.data).data;
    document.getElementById('live-home-score').textContent = d.home_score;
    document.getElementById('live-away-score').textContent = d.away_score;
    document.getElementById('live-status').textContent = 'FINAL';
    document.getElementById('live-status').className = 'live-status live-final';
  });

  es.addEventListener('presentation.round_finished', function(e) {
    setTimeout(function() {
      window.location.reload();
    }, 2000);
  });
})();

function advanceRound() {
  var btn = document.getElementById('advance-btn');
  var status = document.getElementById('advance-status');
  btn.disabled = true;
  status.textContent = 'Starting...';
  fetch('/api/pace/advance', { method: 'POST' })
    .then(function(r) {
      if (r.status === 409) {
        status.textContent = 'Already running';
        btn.disabled = false;
        return;
      }
      if (!r.ok) {
        status.textContent = 'Error: ' + r.status;
        btn.disabled = false;
        return;
      }
      status.textContent = 'Round advancing...';
    })
    .catch(function(err) {
      status.textContent = 'Failed';
      btn.disabled = false;
    });
}
</script>
{% endblock %}
