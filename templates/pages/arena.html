{% extends "base.html" %}
{% block title %}Arena â€” Pinwheel Fates{% endblock %}

{% block content %}
<div class="page-header">
  <h2>The Arena</h2>
  {% if rounds %}
  <p class="subtitle">{{ rounds|length }} round{{ 's' if rounds|length != 1 else '' }} &middot; {{ rounds|sum(attribute='games'|length) if false else rounds|map(attribute='games')|map('length')|sum }} games</p>
  {% endif %}
</div>

{% if rounds %}
<div hx-ext="sse" sse-connect="/api/events/stream">
  {% for round in rounds %}
  <div class="{% if not loop.first %}mt-2{% endif %}">
    <div class="section-title">Round {{ round.round_number }}</div>
    <div class="arena-grid">
      {% for game in round.games %}
      <a href="/games/{{ game.id }}" class="game-panel {% if game.elam_target %}elam{% endif %}" style="text-decoration:none; color:inherit;">
        {% if game.winning_play %}
        <div class="elam-banner">{{ game.winning_play.action }}</div>
        {% elif game.elam_target %}
        <div class="elam-banner">Elam Ending &mdash; Target: {{ game.elam_target }}</div>
        {% endif %}
        <div class="game-panel-header">
          <span class="game-meta">Game {{ game.matchup_index + 1 }}</span>
          <span class="game-meta">{{ game.total_possessions }} poss</span>
        </div>
        <div class="game-panel-teams">
          <div class="team-score-block">
            <div class="team-name {% if game.winner_team_id == game.home_team_id %}winner{% endif %}">
              {{ game.home_name }}
            </div>
            <div class="score score-sm {% if game.winner_team_id == game.home_team_id %}score-winner{% else %}score-loser{% endif %}">
              {{ game.home_score }}
            </div>
          </div>
          <div class="vs-divider">Final</div>
          <div class="team-score-block">
            <div class="team-name {% if game.winner_team_id == game.away_team_id %}winner{% endif %}">
              {{ game.away_name }}
            </div>
            <div class="score score-sm {% if game.winner_team_id == game.away_team_id %}score-winner{% else %}score-loser{% endif %}">
              {{ game.away_score }}
            </div>
          </div>
        </div>
        {% if game.quarter_scores %}
        <table class="quarter-table">
          <thead>
            <tr>
              <th></th>
              {% for qs in game.quarter_scores %}
              <th>Q{{ loop.index }}</th>
              {% endfor %}
              <th>T</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="qt-team">{{ game.home_name[:3] | upper }}</td>
              {% for qs in game.quarter_scores %}
              <td class="{% if qs.home_score > qs.away_score %}qt-bold{% endif %}">{{ qs.home_score }}</td>
              {% endfor %}
              <td class="qt-total {% if game.winner_team_id == game.home_team_id %}qt-bold{% endif %}">{{ game.home_score }}</td>
            </tr>
            <tr>
              <td class="qt-team">{{ game.away_name[:3] | upper }}</td>
              {% for qs in game.quarter_scores %}
              <td class="{% if qs.away_score > qs.home_score %}qt-bold{% endif %}">{{ qs.away_score }}</td>
              {% endfor %}
              <td class="qt-total {% if game.winner_team_id == game.away_team_id %}qt-bold{% endif %}">{{ game.away_score }}</td>
            </tr>
          </tbody>
        </table>
        {% endif %}
      </a>
      {% endfor %}
    </div>

    {% if round.mirror %}
    <div class="mirror-card mt-1">
      <div class="mirror-type">Simulation Mirror &mdash; Round {{ round.mirror.round_number }}</div>
      <div class="mirror-content">{{ round.mirror.content }}</div>
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>

{% else %}
<div class="empty-state">
  <h3>No Games Yet</h3>
  <p>The season hasn't started. Games will appear here once the first round is simulated.</p>
</div>
{% endif %}
{% endblock %}
