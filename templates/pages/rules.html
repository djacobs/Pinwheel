{% extends "base.html" %}
{% block title %}The Rules â€” Pinwheel Fates{% endblock %}

{% block content %}
<div class="rules-hero">
  <h1>The Rules</h1>
  <p class="rules-hero-tagline">
    You can propose <em>anything</em>. Make the floor lava. Switch to baseball.
    Ban left-handed dunks. Write it in plain English &mdash; the AI figures out
    how to make it real. Your team votes. If it passes, the game changes.
    The numbers below are just where it starts.
  </p>
  {% if community_changes > 0 %}
  <div class="rules-hero-stat">
    <span style="color:var(--accent-highlight); font-weight:800;">{{ community_changes }}</span>
    rule{{ 's' if community_changes != 1 else '' }} changed by the community
    {% if most_changed_tier %}
    <span style="color:var(--text-muted); font-weight:400; margin-left:1rem;">
      &middot; Most changed: {{ most_changed_tier }}
    </span>
    {% endif %}
  </div>
  {% endif %}
</div>

{# ===== THE WILD CARD ===== #}
<div class="rules-wildcard">
  <div class="wildcard-inner">
    <div class="wildcard-label">Beyond the Numbers</div>
    <h2 class="wildcard-headline">
      Want to change the rules? Propose new ones &mdash;
      <span class="wc-accent">anything.</span>
    </h2>
    <p class="wildcard-body">
      Want to make the floor lava? Introduce a maximum height rule? Switch to
      baseball? Require all players to hop on one foot? <strong>Write it in
      plain English.</strong> The AI interprets your proposal into mechanics.
      Your team votes. If it passes, it reshapes the game. The simulation
      engine evolves to match.
    </p>

    <div class="wildcard-examples">
      <div class="wildcard-example">
        &ldquo;Make three-pointers worth 10 points when scored in the last minute.&rdquo;
      </div>
      <div class="wildcard-example">
        &ldquo;If a team scores 5 times in a row, the other team gets a free possession.&rdquo;
      </div>
      <div class="wildcard-example">
        &ldquo;Switch to baseball for one round.&rdquo;
      </div>
      <div class="wildcard-example">
        &ldquo;All hoopers must have at least 30 Speed.&rdquo;
      </div>
      <div class="wildcard-example">
        &ldquo;If the score is tied at halftime, play the second half with 4 players per team.&rdquo;
      </div>
      <div class="wildcard-example">
        &ldquo;Add a weather system &mdash; rain reduces three-point accuracy by 20%.&rdquo;
      </div>
    </div>

    <div class="wildcard-flow">
      <span class="wildcard-flow-step">You propose</span>
      <span class="wildcard-flow-arrow">&rarr;</span>
      <span class="wildcard-flow-step">AI interprets</span>
      <span class="wildcard-flow-arrow">&rarr;</span>
      <span class="wildcard-flow-step">Your team votes</span>
      <span class="wildcard-flow-arrow">&rarr;</span>
      <span class="wildcard-flow-step">The game changes</span>
    </div>
  </div>
</div>

{% if changes_from_default %}
<div class="home-section">
  <div class="section-title-bar">
    <span class="section-title-text" style="color:var(--accent-highlight);">Changed by the Community</span>
  </div>
  <div class="rules-changed-strip">
    {% for param, info in changes_from_default.items() %}
    <div class="rule-changed-card">
      <div class="rule-changed-param">{{ param.replace('_', ' ').title() }}</div>
      <div class="rule-changed-values">
        <span class="rule-old">{{ info.default }}</span>
        <span class="rule-arrow">&rarr;</span>
        <span class="rule-new">{{ info.current }}</span>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<div class="rules-starting-point">
  <strong>The starting parameters.</strong> These numbers are where every season begins &mdash;
  but the game goes wherever you take it.
</div>

{% for tier in tiers %}
<div class="home-section">
  <div class="section-title-bar">
    <span class="section-title-text">{{ tier.title }}</span>
  </div>
  <p class="rules-tier-subtitle">{{ tier.subtitle }}</p>
  <div class="rules-tier-grid">
    {% for rule in tier.rules %}
    <div class="rule-card {% if rule.changed %}rule-card-changed{% endif %} {% if rule.get('drift_pct', 0) >= 50 %}rule-card-high-drift{% endif %}">
      <div class="rule-card-header">
        <span class="rule-card-label">{{ rule.label }}</span>
        {% if rule.value is sameas true %}
        <span class="rule-card-value rule-bool-on">ON</span>
        {% elif rule.value is sameas false %}
        <span class="rule-card-value rule-bool-off">OFF</span>
        {% else %}
        <span class="rule-card-value {% if rule.changed %}rule-card-value-changed{% endif %}">{{ rule.value }}</span>
        {% endif %}
      </div>
      {# Drift bar: visual indicator of how far from default #}
      {% if rule.changed and rule.get('drift_pct', 0) > 0 %}
      <div class="rule-drift-bar-container">
        <div class="rule-drift-bar" style="width: {{ [rule.get('drift_pct', 0), 100] | min }}%"></div>
        <span class="rule-drift-label">{{ rule.get('drift_pct', 0) }}% from default ({{ rule.default }})</span>
      </div>
      {% elif rule.changed %}
      <div class="rule-drift-label-only">Changed from default ({{ rule.default }})</div>
      {% endif %}
      <div class="rule-card-desc">{{ rule.desc }}</div>
      {% if rule.range %}
      <div class="rule-card-range">Range: {{ rule.range }}</div>
      {% endif %}
      {% if rule.get('change_count', 0) > 0 %}
      <div class="rule-card-change-count">{{ rule.change_count }} change{{ 's' if rule.change_count != 1 else '' }} this season</div>
      {% endif %}
      {% if rule.history %}
      <div class="rule-card-history">
        <div class="rule-history-header">Change History</div>
        {% for change in rule.history %}
        <div class="rule-change-entry">
          <div class="rule-change-top-row">
            <span class="rule-change-arrow">{{ change.old_value }} &rarr; {{ change.new_value }}</span>
            <span class="rule-change-round">Round {{ change.round_enacted }}</span>
          </div>
          {% if change.governor_name or change.governor_id %}
          <div class="rule-change-attribution">
            {% if change.governor_name %}
            <span class="rule-change-proposer">
              <a href="/governors/{{ change.governor_id }}">{{ change.governor_name }}</a>
            </span>
            {% elif change.governor_id %}
            <span class="rule-change-proposer">
              <a href="/governors/{{ change.governor_id }}">Governor</a>
            </span>
            {% endif %}
            {% if change.vote_margin %}
            <span class="rule-change-vote-margin" title="Vote: {{ change.vote_margin }}">Passed {{ change.vote_margin }}</span>
            {% endif %}
          </div>
          {% endif %}
          {% if change.raw_text %}
          <div class="rule-change-proposal-text">&ldquo;{{ change.raw_text }}&rdquo;</div>
          {% endif %}
          {% if change.impact %}
          <div class="rule-change-impact">{{ change.impact }}</div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
</div>
{% endfor %}

{% if rule_history %}
<div class="home-section">
  <div class="section-title-bar">
    <span class="section-title-text">Change Timeline</span>
  </div>
  <div class="rule-timeline">
    {% for rc in rule_history %}
    <div class="rule-history-item">
      <span class="rule-history-param">{{ rc.parameter.replace('_', ' ').title() }}</span>
      <span class="rule-history-change">
        <span class="rule-old">{{ rc.old_value }}</span>
        <span class="rule-arrow">&rarr;</span>
        <span class="rule-new">{{ rc.new_value }}</span>
      </span>
      <span class="rule-history-round">Round {{ rc.round_enacted }}</span>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<div class="rules-cta">
  <p>Want to change a rule &mdash; or invent a new one? <a href="/play">Join the league</a> and use <code>/propose</code> in Discord.</p>
  <p class="text-muted text-sm">
    Write your proposal in plain English &mdash; anything goes. The AI
    interprets it into mechanics. Your team votes. Passed proposals take
    effect next round.
  </p>
</div>
{% endblock %}
