{% extends "base.html" %}
{% block title %}The Floor â€” Pinwheel Fates{% endblock %}

{% block content %}
<div class="rules-hero" style="padding-bottom:1.5rem;">
  <h1>The Floor
    {% if season_phase == 'playoffs' %}
    <span style="color: var(--accent-elam); font-size: 0.5em; vertical-align: middle; margin-left: 0.5rem;">PLAYOFFS</span>
    {% elif season_phase == 'championship' %}
    <span style="color: var(--accent-score); font-size: 0.5em; vertical-align: middle; margin-left: 0.5rem;">CHAMPIONSHIP</span>
    {% endif %}
  </h1>
  <p class="rules-hero-tagline">
    Every rule change starts with a proposal from a player. Write it in plain English.
    The AI translates it into a specific parameter change. Your team votes.
    Pass it, and you've rewritten the game.
  </p>
  {% if season_phase == 'playoffs' %}
  <p class="text-xs" style="color: var(--accent-elam); margin-top: 0.5rem;">
    Playoff governance &mdash; rule changes enacted now apply to elimination games.
  </p>
  {% elif season_phase == 'championship' %}
  <p class="text-xs" style="color: var(--accent-score); margin-top: 0.5rem;">
    Championship governance &mdash; the final rules of the season are being written.
  </p>
  {% endif %}
</div>

{% if proposals %}
<div class="section-title">Proposals</div>
{% for p in proposals %}
<div class="proposal-card {{ p.status }}">
  <div class="flex justify-between items-center mb-1">
    {% if p.status == 'passed' %}
    <span class="status-badge status-passed">PASSED</span>
    {% elif p.status == 'failed' %}
    <span class="status-badge status-failed">FAILED</span>
    {% elif p.status == 'confirmed' %}
    <span class="status-badge status-confirmed">OPEN FOR VOTING</span>
    {% else %}
    <span class="status-badge status-{{ p.status }}">{{ p.status|upper }}</span>
    {% endif %}
    <span class="text-xs text-muted">Tier {{ p.tier }}</span>
  </div>
  <div class="proposal-text">"{{ p.raw_text }}"</div>
  {% if p.interpretation and p.interpretation.impact_analysis %}
  <div class="proposal-interpretation">
    <strong>AI Interpretation:</strong>
    {{ p.interpretation.impact_analysis }}
    {% if p.interpretation.confidence and p.interpretation.confidence >= 0.5 %}
    <br><span class="text-xs text-muted">Confidence: {{ "%.0f"|format(p.interpretation.confidence * 100) }}%</span>
    {% endif %}
  </div>
  {% endif %}
  {% if p.vote_tally %}
  <div class="vote-tally mt-1">
    {% set total = p.vote_tally.yes + p.vote_tally.no %}
    {% if total > 0 %}
    {% set pct = (p.vote_tally.yes / total * 100)|round(0)|int %}
    <div class="tally-bar">
      <div class="tally-yes" style="width: {{ pct }}%"></div>
    </div>
    <div class="tally-numbers">
      <span class="tally-yes-label">{{ "%.1f"|format(p.vote_tally.yes) }} Yes</span>
      <span class="text-xs text-muted">{{ p.vote_tally.count }} vote{{ 's' if p.vote_tally.count != 1 else '' }} &middot; {{ pct }}% approval</span>
      <span class="tally-no-label">{{ "%.1f"|format(p.vote_tally.no) }} No</span>
    </div>
    {% else %}
    <span class="text-xs text-muted">No votes cast yet</span>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endfor %}
{% else %}
<div class="empty-state">
  <h3>No Proposals Yet</h3>
  <p>No proposals yet. Use the <code>/propose</code> command in Discord to submit a rule change.</p>
</div>
{% endif %}

{% if rules_changed %}
<div class="section-title mt-2">Rule Changes Enacted</div>
{% for rc in rules_changed %}
<div class="card mb-1">
  <div class="card-body">
    <strong>{{ rc.parameter_label }}</strong>:
    <span class="text-muted">{{ rc.old_value }}</span> &rarr;
    <span style="color: var(--accent-highlight); font-weight:700;">{{ rc.new_value }}</span>
    <span class="text-xs text-muted">&middot; Round {{ rc.round_enacted }}</span>
  </div>
</div>
{% endfor %}
{% endif %}
{% endblock %}
