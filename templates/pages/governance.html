{% extends "base.html" %}
{% block title %}Governance â€” Pinwheel Fates{% endblock %}

{% block content %}
<h2 class="mb-2">Governance Audit Trail</h2>

{% if proposals %}
<div class="section-title">Proposals</div>
{% for p in proposals %}
<div class="proposal-card {{ p.status }}">
  <div class="flex justify-between items-center mb-1">
    {% if p.status == 'passed' %}
    <span class="status-badge status-passed">PASSED</span>
    {% elif p.status == 'failed' %}
    <span class="status-badge status-failed">FAILED</span>
    {% elif p.status == 'confirmed' %}
    <span class="status-badge status-confirmed">OPEN FOR VOTING</span>
    {% else %}
    <span class="status-badge status-{{ p.status }}">{{ p.status|upper }}</span>
    {% endif %}
    <span class="text-xs text-muted">Tier {{ p.tier }}</span>
  </div>
  <div class="proposal-text">"{{ p.raw_text }}"</div>
  {% if p.interpretation %}
  <div class="proposal-interpretation">
    <strong>AI Interpretation:</strong>
    {% if p.interpretation.parameter %}
      Change <code>{{ p.interpretation.parameter }}</code>
      {% if p.interpretation.old_value is not none %}from {{ p.interpretation.old_value }}{% endif %}
      {% if p.interpretation.new_value is not none %}to {{ p.interpretation.new_value }}{% endif %}
    {% endif %}
    {% if p.interpretation.impact_analysis %}
    <br>{{ p.interpretation.impact_analysis }}
    {% endif %}
    {% if p.interpretation.confidence %}
    <br><span class="text-xs text-muted">Confidence: {{ "%.0f"|format(p.interpretation.confidence * 100) }}%</span>
    {% endif %}
  </div>
  {% endif %}
  {% if p.vote_tally %}
  <div class="vote-tally mt-1">
    {% set total = p.vote_tally.yes + p.vote_tally.no %}
    {% if total > 0 %}
    {% set pct = (p.vote_tally.yes / total * 100)|round(0)|int %}
    <div class="tally-bar">
      <div class="tally-yes" style="width: {{ pct }}%"></div>
    </div>
    <div class="tally-numbers">
      <span class="tally-yes-label">{{ "%.1f"|format(p.vote_tally.yes) }} Yes</span>
      <span class="text-xs text-muted">{{ p.vote_tally.count }} vote{{ 's' if p.vote_tally.count != 1 else '' }} &middot; {{ pct }}% approval</span>
      <span class="tally-no-label">{{ "%.1f"|format(p.vote_tally.no) }} No</span>
    </div>
    {% else %}
    <span class="text-xs text-muted">No votes cast yet</span>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endfor %}
{% else %}
<div class="empty-state">
  <h3>No Proposals Yet</h3>
  <p>No proposals yet. Use the <code>/propose</code> command in Discord to submit a rule change.</p>
</div>
{% endif %}

{% if rules_changed %}
<div class="section-title mt-2">Rule Changes Enacted</div>
{% for rc in rules_changed %}
<div class="card mb-1">
  <div class="card-body">
    <code>{{ rc.parameter }}</code>:
    <span class="text-muted">{{ rc.old_value }}</span> &rarr;
    <span style="color: var(--accent-highlight); font-weight:700;">{{ rc.new_value }}</span>
    <span class="text-xs text-muted">&middot; Round {{ rc.round_enacted }}</span>
  </div>
</div>
{% endfor %}
{% endif %}
{% endblock %}
