{% extends "base.html" %}
{% block title %}Playoffs â€” Pinwheel Fates{% endblock %}

{% block content %}
<div class="page-header">
  <h2>Playoff Bracket</h2>
  {% if bracket.season_name %}
  <p class="subtitle">
    {{ bracket.season_name }}
    {% if bracket.phase == 'playoffs' %}
      &middot; <span style="color: var(--accent-elam); font-weight: 700;">IN PROGRESS</span>
    {% elif bracket.phase == 'complete' %}
      &middot; <span style="color: var(--accent-score); font-weight: 700;">COMPLETE</span>
    {% elif bracket.phase == 'tiebreakers' %}
      &middot; <span style="color: var(--accent-highlight); font-weight: 700;">TIEBREAKERS</span>
    {% endif %}
  </p>
  {% endif %}
</div>

{% if bracket.champion %}
<div class="card" style="border: 2px solid var(--accent-score); margin-bottom: 1.5rem; text-align: center; padding: 1.5rem;">
  <div style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.15em; color: var(--accent-score); margin-bottom: 0.5rem;">Champion</div>
  <div class="tc" style="--tc: {{ bracket.champion.color }}; --tcl: {{ bracket.champion.color|light_safe }}; font-size: 1.8rem; font-weight: 800;">
    {{ bracket.champion.team_name }}
  </div>
</div>
{% endif %}

{% if bracket.semifinals or bracket.finals %}

<!-- Bracket container -->
<div class="bracket-container">

  {% if bracket.semifinals %}
  <div class="section-title" style="color: var(--accent-elam);">Semifinals</div>
  <div class="bracket-round">
    {% for semi in bracket.semifinals %}
    <div class="bracket-matchup card">
      <div class="bracket-matchup-header">
        Semifinal {{ loop.index }}
        {% if semi.games %}
        <span class="bracket-series-score">
          {{ semi.seed_high.team_name }} {{ semi.seed_high.wins }} &ndash; {{ semi.seed_low.wins }} {{ semi.seed_low.team_name }}
        </span>
        {% endif %}
      </div>
      <div class="bracket-teams">
        <div class="bracket-team {% if semi.seed_high.wins > semi.seed_low.wins %}bracket-team-leading{% endif %}" style="--tc: {{ semi.seed_high.color }}; --tcl: {{ semi.seed_high.color|light_safe }}; border-left: 3px solid var(--tcl, var(--tc));">
          <span class="bracket-seed">#{{ semi.seed_high.seed }}</span>
          <a href="/teams/{{ semi.seed_high.team_id }}" class="bracket-team-name {% if semi.seed_high.wins > semi.seed_low.wins %}tc{% endif %}">{{ semi.seed_high.team_name }}</a>
          <span class="bracket-wins">{{ semi.seed_high.wins }}</span>
        </div>
        <div class="bracket-team {% if semi.seed_low.wins > semi.seed_high.wins %}bracket-team-leading{% endif %}" style="--tc: {{ semi.seed_low.color }}; --tcl: {{ semi.seed_low.color|light_safe }}; border-left: 3px solid var(--tcl, var(--tc));">
          <span class="bracket-seed">#{{ semi.seed_low.seed }}</span>
          <a href="/teams/{{ semi.seed_low.team_id }}" class="bracket-team-name {% if semi.seed_low.wins > semi.seed_high.wins %}tc{% endif %}">{{ semi.seed_low.team_name }}</a>
          <span class="bracket-wins">{{ semi.seed_low.wins }}</span>
        </div>
      </div>
      {% if semi.games %}
      <div class="bracket-games">
        {% for game in semi.games %}
        <a href="/games/{{ game.game_id }}" class="bracket-game-row">
          <span class="bracket-game-label">Game {{ loop.index }}</span>
          <span class="bracket-game-score {% if game.winner_team_id == game.home_team_id %}bracket-game-winner{% endif %}">{{ game.home_score }}</span>
          <span class="bracket-game-dash">&ndash;</span>
          <span class="bracket-game-score {% if game.winner_team_id == game.away_team_id %}bracket-game-winner{% endif %}">{{ game.away_score }}</span>
        </a>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {% if bracket.finals %}
  <div class="section-title" style="color: var(--accent-score); margin-top: 1.5rem;">
    {% if bracket.champion %}Championship Finals{% else %}Finals{% endif %}
  </div>
  <div class="bracket-round bracket-round-finals">
    <div class="bracket-matchup card {% if bracket.champion %}bracket-matchup-champion{% endif %}">
      <div class="bracket-matchup-header">
        Finals
        {% if bracket.finals.games %}
        <span class="bracket-series-score">
          {{ bracket.finals.team_a.team_name }} {{ bracket.finals.team_a.wins }} &ndash; {{ bracket.finals.team_b.wins }} {{ bracket.finals.team_b.team_name }}
        </span>
        {% endif %}
      </div>
      <div class="bracket-teams">
        <div class="bracket-team {% if bracket.finals.team_a.wins > bracket.finals.team_b.wins %}bracket-team-leading{% endif %}" style="--tc: {{ bracket.finals.team_a.color }}; --tcl: {{ bracket.finals.team_a.color|light_safe }}; border-left: 3px solid var(--tcl, var(--tc));">
          {% if bracket.finals.team_a.seed %}<span class="bracket-seed">#{{ bracket.finals.team_a.seed }}</span>{% endif %}
          <a href="/teams/{{ bracket.finals.team_a.team_id }}" class="bracket-team-name {% if bracket.finals.team_a.wins > bracket.finals.team_b.wins %}tc{% endif %}">{{ bracket.finals.team_a.team_name }}</a>
          <span class="bracket-wins">{{ bracket.finals.team_a.wins }}</span>
        </div>
        <div class="bracket-team {% if bracket.finals.team_b.wins > bracket.finals.team_a.wins %}bracket-team-leading{% endif %}" style="--tc: {{ bracket.finals.team_b.color }}; --tcl: {{ bracket.finals.team_b.color|light_safe }}; border-left: 3px solid var(--tcl, var(--tc));">
          {% if bracket.finals.team_b.seed %}<span class="bracket-seed">#{{ bracket.finals.team_b.seed }}</span>{% endif %}
          <a href="/teams/{{ bracket.finals.team_b.team_id }}" class="bracket-team-name {% if bracket.finals.team_b.wins > bracket.finals.team_a.wins %}tc{% endif %}">{{ bracket.finals.team_b.team_name }}</a>
          <span class="bracket-wins">{{ bracket.finals.team_b.wins }}</span>
        </div>
      </div>
      {% if bracket.finals.games %}
      <div class="bracket-games">
        {% for game in bracket.finals.games %}
        <a href="/games/{{ game.game_id }}" class="bracket-game-row">
          <span class="bracket-game-label">Game {{ loop.index }}</span>
          <span class="bracket-game-score {% if game.winner_team_id == game.home_team_id %}bracket-game-winner{% endif %}">{{ game.home_score }}</span>
          <span class="bracket-game-dash">&ndash;</span>
          <span class="bracket-game-score {% if game.winner_team_id == game.away_team_id %}bracket-game-winner{% endif %}">{{ game.away_score }}</span>
        </a>
        {% endfor %}
      </div>
      {% endif %}
    </div>
  </div>
  {% elif bracket.semifinals and not bracket.finals %}
  <div class="section-title" style="color: var(--text-muted); margin-top: 1.5rem;">Finals</div>
  <div class="bracket-round bracket-round-finals">
    <div class="bracket-matchup card" style="opacity: 0.5;">
      <div class="bracket-matchup-header">Finals</div>
      <div class="bracket-teams">
        <div class="bracket-team" style="border-left: 3px solid var(--border);">
          <span class="bracket-team-name" style="color: var(--text-muted);">TBD</span>
          <span class="bracket-wins">&ndash;</span>
        </div>
        <div class="bracket-team" style="border-left: 3px solid var(--border);">
          <span class="bracket-team-name" style="color: var(--text-muted);">TBD</span>
          <span class="bracket-wins">&ndash;</span>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

</div>

{% else %}
<div class="empty-state">
  <h3>No Playoff Bracket Yet</h3>
  {% if bracket.phase == 'regular_season' %}
  <p>The regular season is still in progress. The playoff bracket will appear once the regular season is complete.</p>
  {% elif bracket.phase == 'tiebreakers' %}
  <p>Tiebreaker games are being played to determine playoff seeding.</p>
  {% elif bracket.phase == 'none' %}
  <p>No active season found.</p>
  {% else %}
  <p>Playoffs have not started yet.</p>
  {% endif %}
</div>
{% endif %}

<style>
  .bracket-container {
    margin-top: 1rem;
  }
  .bracket-round {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .bracket-round-finals {
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
  }
  .bracket-matchup {
    padding: 1rem;
  }
  .bracket-matchup-champion {
    border: 1px solid var(--accent-score);
  }
  .bracket-matchup-header {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .bracket-series-score {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-secondary);
  }
  .bracket-teams {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .bracket-team {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--bg-secondary);
    border-radius: var(--radius, 6px);
  }
  .bracket-team-leading {
    background: var(--bg-card-hover);
  }
  .bracket-seed {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-muted);
    min-width: 1.5rem;
  }
  .bracket-team-name {
    flex: 1;
    font-weight: 600;
    color: var(--text-primary);
    text-decoration: none;
  }
  .bracket-team-name:hover {
    color: var(--accent-governance);
  }
  .bracket-wins {
    font-family: var(--font-mono);
    font-size: 1.2rem;
    font-weight: 800;
    color: var(--text-primary);
    min-width: 1.5rem;
    text-align: center;
  }
  .bracket-games {
    margin-top: 0.75rem;
    border-top: 1px solid var(--border);
    padding-top: 0.5rem;
  }
  .bracket-game-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0;
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--text-secondary);
    text-decoration: none;
  }
  .bracket-game-row:hover {
    color: var(--accent-governance);
  }
  .bracket-game-label {
    min-width: 4rem;
    color: var(--text-muted);
  }
  .bracket-game-score {
    min-width: 2rem;
    text-align: center;
  }
  .bracket-game-winner {
    color: var(--accent-score);
    font-weight: 700;
  }
  .bracket-game-dash {
    color: var(--text-muted);
  }
</style>
{% endblock %}
