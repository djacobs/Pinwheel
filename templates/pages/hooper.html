{% extends "base.html" %}
{% from "components/spider_chart.html" import spider %}
{% block title %}{{ hooper.name }} — Pinwheel Fates{% endblock %}

{% block content %}
{# Header #}
<div class="hooper-page-header">
  <div>
    <h1>{{ hooper.name }}</h1>
    <div class="flex items-center gap-1">
      <span class="hooper-archetype">{{ hooper.archetype }}</span>
      {% if team %}
      <span class="text-muted">&middot;</span>
      <a href="/teams/{{ team.id }}" class="team-link-sm">
        <span class="team-dot-sm tc-dot" style="--tc: {{ team.color }};"></span>
        {{ team.name }}
      </a>
      {% endif %}
    </div>
  </div>
</div>

{# Bio #}
<div id="hooper-bio" class="hooper-bio mb-2">
  {% if hooper.backstory %}
  <p>{{ hooper.backstory }}</p>
  {% else %}
  <p class="text-muted">No bio yet.</p>
  {% endif %}
  {% if can_edit_bio %}
  <button class="bio-edit-btn"
          hx-get="/hoopers/{{ hooper.id }}/bio/edit"
          hx-target="#hooper-bio"
          hx-swap="innerHTML">Edit Bio</button>
  {% endif %}
</div>

{# Two-column: Spider chart + Season averages #}
<div class="hooper-detail-grid mb-2">
  {# Spider chart #}
  <div class="card">
    <div class="card-header">
      <h3>Attributes</h3>
    </div>
    <div class="card-body" style="display:flex; flex-direction:column; align-items:center;">
      {{ spider(spider_points, avg_points, grid_rings, axis_lines, spider_poly, avg_poly, team_color=team.color if team else "#53d8fb", size="lg") }}
    </div>
  </div>

  {# Season averages #}
  <div class="card">
    <div class="card-header">
      <h3>Season Averages</h3>
    </div>
    <div class="card-body">
      {% if season_averages %}
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value">{{ season_averages.ppg }}</div>
          <div class="stat-label">PPG</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ season_averages.apg }}</div>
          <div class="stat-label">APG</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ season_averages.spg }}</div>
          <div class="stat-label">SPG</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ season_averages.topg }}</div>
          <div class="stat-label">TOPG</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ season_averages.fg_pct }}%</div>
          <div class="stat-label">FG%</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ season_averages.three_pct }}%</div>
          <div class="stat-label">3P%</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ season_averages.ft_pct }}%</div>
          <div class="stat-label">FT%</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ season_averages.games_played }}</div>
          <div class="stat-label">GP</div>
        </div>
      </div>
      {% else %}
      <p class="text-muted text-sm">No games played yet.</p>
      {% endif %}
    </div>
  </div>
</div>

{# Career Performance (one aggregate row per season) #}
{% if career_seasons %}
<div class="card mb-2">
  <div class="card-header">
    <h3>Career Performance</h3>
  </div>
  <div class="card-body" style="padding: 0;">
    <table class="box-score-table">
      <thead>
        <tr>
          <th style="text-align:left">SEASON</th>
          <th>GP</th>
          <th>PPG</th>
          <th>FG%</th>
          <th>3P%</th>
          <th>FT%</th>
          <th>APG</th>
          <th>SPG</th>
          <th>TOPG</th>
        </tr>
      </thead>
      <tbody>
        {% for cs in career_seasons %}
        <tr{% if cs.is_current %} class="career-current-season"{% endif %}>
          <td style="text-align:left; font-family: var(--font-body); font-weight: 600;">
            {{ cs.season_name }}{% if cs.is_current %} <span class="text-muted text-xs">(current)</span>{% endif %}
          </td>
          <td>{{ cs.games_played }}</td>
          {% if cs.averages %}
          <td>{% if cs.ppg_is_league_best %}<strong>{{ cs.averages.ppg }}</strong>{% else %}{{ cs.averages.ppg }}{% endif %}</td>
          <td>{% if cs.fg_pct_is_league_best %}<strong>{{ cs.averages.fg_pct }}%</strong>{% else %}{{ cs.averages.fg_pct }}%{% endif %}</td>
          <td>{% if cs.three_pct_is_league_best %}<strong>{{ cs.averages.three_pct }}%</strong>{% else %}{{ cs.averages.three_pct }}%{% endif %}</td>
          <td>{% if cs.ft_pct_is_league_best %}<strong>{{ cs.averages.ft_pct }}%</strong>{% else %}{{ cs.averages.ft_pct }}%{% endif %}</td>
          <td>{% if cs.apg_is_league_best %}<strong>{{ cs.averages.apg }}</strong>{% else %}{{ cs.averages.apg }}{% endif %}</td>
          <td>{% if cs.spg_is_league_best %}<strong>{{ cs.averages.spg }}</strong>{% else %}{{ cs.averages.spg }}{% endif %}</td>
          <td>{% if cs.topg_is_league_best %}<strong>{{ cs.averages.topg }}</strong>{% else %}{{ cs.averages.topg }}{% endif %}</td>
          {% else %}
          <td colspan="7" class="text-muted">—</td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{# Game Log — current season, game by game #}
{% if game_log %}
<div class="card mb-2">
  <div class="card-header">
    <h3>Game Log</h3>
    <span class="text-muted text-xs" style="font-weight: 400; margin-left: 0.5rem;">{{ current_season_name }}</span>
    <span class="text-muted text-xs" style="margin-left: 0.5rem;">— <strong style="color: var(--accent-score)">★</strong> league high, <strong>bold</strong> personal best, * playoff</span>
  </div>
  <div class="card-body" style="padding: 0;">
    <table class="box-score-table">
      <thead>
        <tr>
          <th style="text-align:left">RD</th>
          <th style="text-align:left">OPP</th>
          <th>PTS</th>
          <th>FG</th>
          <th>3P</th>
          <th>FT</th>
          <th>AST</th>
          <th>STL</th>
          <th>TO</th>
        </tr>
      </thead>
      <tbody>
        {% for g in game_log %}
        <tr>
          <td style="text-align:left">
            <a href="/games/{{ g.game_id }}">{{ g.round_number }}{% if g.is_playoff %}*{% endif %}</a>
          </td>
          <td style="text-align:left; font-family: var(--font-body); font-weight: 600;">
            {{ g.opponent_name }}
          </td>
          <td>
            {% if g.pts_is_league_best %}<strong style="color: var(--accent-score)">{{ g.points }}★</strong>
            {% elif g.pts_is_personal_best %}<strong>{{ g.points }}</strong>
            {% else %}{{ g.points }}{% endif %}
          </td>
          <td>{{ g.field_goals_made }}-{{ g.field_goals_attempted }}</td>
          <td>{{ g.three_pointers_made }}-{{ g.three_pointers_attempted }}</td>
          <td>{{ g.free_throws_made }}-{{ g.free_throws_attempted }}</td>
          <td>
            {% if g.ast_is_league_best %}<strong style="color: var(--accent-score)">{{ g.assists }}★</strong>
            {% elif g.ast_is_personal_best %}<strong>{{ g.assists }}</strong>
            {% else %}{{ g.assists }}{% endif %}
          </td>
          <td>
            {% if g.stl_is_league_best %}<strong style="color: var(--accent-score)">{{ g.steals }}★</strong>
            {% elif g.stl_is_personal_best %}<strong>{{ g.steals }}</strong>
            {% else %}{{ g.steals }}{% endif %}
          </td>
          <td>{{ g.turnovers }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{# Moves #}
{% if hooper.moves %}
<div class="card mb-2">
  <div class="card-header">
    <h3>Special Moves</h3>
  </div>
  <div class="card-body">
    {% for move in hooper.moves %}
    <div class="move-item {% if not loop.last %}mb-1{% endif %}">
      <div class="move-name">{{ move.name if move is mapping else move }}</div>
      {% if move is mapping %}
      {% if move.trigger %}
      <div class="move-detail"><span class="text-muted text-xs">TRIGGER</span> {{ move.trigger }}</div>
      {% endif %}
      {% if move.effect %}
      <div class="move-detail"><span class="text-muted text-xs">EFFECT</span> {{ move.effect }}</div>
      {% endif %}
      {% endif %}
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

{% if team %}
<a href="/teams/{{ team.id }}" class="nav-link">&larr; Back to {{ team.name }}</a>
{% endif %}
{% endblock %}
