{% extends "base.html" %}
{% block title %}Pinwheel Fates{% endblock %}

{% block content %}
{# ===== HERO ===== #}
<div class="home-hero">
  <div class="hero-glow"></div>
  <h1 class="hero-title">
    PINWHEEL <span class="hero-accent">FATES</span>
  </h1>
  <p class="hero-tagline">
    A 3-on-3 basketball sim where the players rewrite the rules.
    {% if discord_invite_url %}
    <a href="{{ discord_invite_url }}" target="_blank" rel="noopener">Join the Discord</a> to pick a team, then propose rule changes and vote.
    {% else %}
    Join the Discord to pick a team, then propose rule changes and vote.
    {% endif %}
    Starts as basketball, becomes&nbsp;???
  </p>
  {% if current_round > 0 %}
  <div class="hero-pulse">
    <span class="pulse-dot"></span>
    <span class="pulse-label">{{ season_name }}</span>
    <span class="pulse-sep">&middot;</span>
    {% if season_phase == 'playoffs' %}
    <span class="pulse-label" style="color: var(--accent-elam); font-weight: 700;">PLAYOFFS</span>
    <span class="pulse-sep">&middot;</span>
    {% elif season_phase == 'championship' %}
    <span class="pulse-label" style="color: var(--accent-score); font-weight: 700;">CHAMPIONSHIP</span>
    <span class="pulse-sep">&middot;</span>
    {% endif %}
    <span class="pulse-label">Round {{ current_round }}</span>
    <span class="pulse-sep">&middot;</span>
    <span class="pulse-label">{{ total_games }} game{{ 's' if total_games != 1 else '' }} played</span>
  </div>
  {% endif %}
</div>

{# ===== WHAT CHANGED ===== #}
{% if what_changed_signals %}
<div class="what-changed" id="what-changed"
     hx-get="/partials/what-changed" hx-trigger="every 60s" hx-swap="outerHTML">
  {% for signal in what_changed_signals %}
  <div class="what-changed-item{% if signal.startswith('Latest:') %} what-changed-fallback{% endif %}">{{ signal }}</div>
  {% endfor %}
</div>
{% else %}
<div id="what-changed"
     hx-get="/partials/what-changed" hx-trigger="every 60s" hx-swap="outerHTML">
</div>
{% endif %}

{# ===== THE PINWHEEL POST ===== #}
{% if post_headline or post_sim_report or post_gov_report %}
<div class="home-post">
  {% if post_sim_report %}
  <div class="home-post-section">
    <div class="home-post-section-header">GAME REPORTS</div>
    <div class="home-post-article">{{ post_sim_report | prose | safe }}</div>
  </div>
  {% endif %}

  {% if post_highlight_reel %}
  <div class="home-post-full-width">
    <div class="home-post-section-header">HIGHLIGHT REEL</div>
    <div class="home-post-article">{{ post_highlight_reel | prose | safe }}</div>
  </div>
  {% endif %}

  {% if post_hot_players %}
  <div class="home-post-hot-players">
    <div class="home-post-section-header">HOT PLAYERS</div>
    {% for hp in post_hot_players %}
    <div class="home-post-stat-line">
      <strong>{{ hp.name }}</strong> ({{ hp.team }}) &mdash; {{ hp.stat }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

</div>
{% endif %}

{# ===== LATEST SCORES ===== #}
{% if latest_round_games %}
<div class="home-section">
  <div class="section-title-bar">
    <span class="section-title-text">Latest Results</span>
    <span class="section-title-badge">Round {{ current_round }}</span>
  </div>
  <div class="scores-strip">
    {% for game in latest_round_games %}
    <a href="/games/{{ game.id }}" class="score-card">
      <div class="sc-teams">
        <div class="sc-team">
          <span class="sc-dot tc-dot" style="--tc: {{ game.home_color }};"></span>
          <span class="sc-name {% if game.winner_team_id == game.home_team_id %}sc-winner{% endif %}">{{ game.home_name }}</span>
          <span class="sc-score {% if game.winner_team_id == game.home_team_id %}sc-score-win{% endif %}">{{ game.home_score }}</span>
        </div>
        <div class="sc-team">
          <span class="sc-dot tc-dot" style="--tc: {{ game.away_color }};"></span>
          <span class="sc-name {% if game.winner_team_id == game.away_team_id %}sc-winner{% endif %}">{{ game.away_name }}</span>
          <span class="sc-score {% if game.winner_team_id == game.away_team_id %}sc-score-win{% endif %}">{{ game.away_score }}</span>
        </div>
      </div>
      {% if game.winning_play %}
      <div class="sc-play">{{ game.winning_play }}</div>
      {% endif %}
      {% if game.elam_target %}
      <div class="sc-elam">Elam {{ game.elam_target }}</div>
      {% endif %}
    </a>
    {% endfor %}
  </div>
  <div class="section-more">
    <a href="/arena" class="more-link">All games &rarr;</a>
  </div>
</div>
{% endif %}

{# ===== STANDINGS + THE FLOOR (Two columns) ===== #}
{% set has_bracket = playoff_standings and (playoff_standings.get('semifinals') or playoff_standings.get('finals')) %}
{% if standings or has_bracket or post_gov_report %}
<div class="home-columns">
  {# Standings #}
  {% if standings or has_bracket %}
  <div class="home-section">
    {# --- Playoff Bracket (shown only when playoff matchups exist) --- #}
    {% if has_bracket %}
    <div class="section-title-bar">
      <span class="section-title-text">Playoffs</span>
    </div>
    {% set semis = playoff_standings.get('semifinals', []) %}
    {% set fin = playoff_standings.get('finals') %}
    {% set champ = playoff_standings.get('champion') %}

    {# --- Bracket with connecting lines --- #}
    <div class="bracket{% if not semis %} bracket-finals-only{% endif %}">
      {% if semis %}
      <div class="bracket-semis">
        {% for semi in semis %}
        <div class="bracket-matchup">
          <div class="bracket-round-label">Semi {{ loop.index }}<span class="bracket-bestof">Bo{{ semis_best_of }}</span></div>
          <div class="bracket-team{% if semi.seed_high.wins > semi.seed_low.wins %} bracket-team-lead{% endif %}">
            <span class="bracket-dot tc-dot" style="--tc: {{ semi.seed_high.color }};"></span>
            <span class="bracket-name">{{ semi.seed_high.team_name }}</span>
            <span class="bracket-wins">{{ semi.seed_high.wins }}<span class="bracket-wins-label">w</span></span>
          </div>
          <div class="bracket-team{% if semi.seed_low.wins > semi.seed_high.wins %} bracket-team-lead{% endif %}">
            <span class="bracket-dot tc-dot" style="--tc: {{ semi.seed_low.color }};"></span>
            <span class="bracket-name">{{ semi.seed_low.team_name }}</span>
            <span class="bracket-wins">{{ semi.seed_low.wins }}<span class="bracket-wins-label">w</span></span>
          </div>
        </div>
        {% endfor %}
      </div>
      <div class="bracket-connector">
        <div class="bracket-line bracket-line-top"></div>
        <div class="bracket-line bracket-line-mid"></div>
        <div class="bracket-line bracket-line-bot"></div>
      </div>
      {% endif %}
      {% if fin %}
      <div class="bracket-finals">
        <div class="bracket-matchup">
          <div class="bracket-round-label">Finals<span class="bracket-bestof">Bo{{ finals_best_of }}</span></div>
          <div class="bracket-team{% if fin.team_a.wins > fin.team_b.wins %} bracket-team-lead{% endif %}">
            <span class="bracket-dot tc-dot" style="--tc: {{ fin.team_a.color }};"></span>
            <span class="bracket-name">{{ fin.team_a.team_name }}</span>
            <span class="bracket-wins">{{ fin.team_a.wins }}<span class="bracket-wins-label">w</span></span>
          </div>
          <div class="bracket-team{% if fin.team_b.wins > fin.team_a.wins %} bracket-team-lead{% endif %}">
            <span class="bracket-dot tc-dot" style="--tc: {{ fin.team_b.color }};"></span>
            <span class="bracket-name">{{ fin.team_b.team_name }}</span>
            <span class="bracket-wins">{{ fin.team_b.wins }}<span class="bracket-wins-label">w</span></span>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    {% if champ %}
    <div class="bracket-champion">
      <span class="bracket-champion-icon">&#9733;</span>
      <span class="bracket-dot tc-dot" style="--tc: {{ champ.color }};"></span>
      <span class="bracket-champion-name">{{ champ.team_name }}</span>
      <span class="bracket-champion-label">Champions</span>
    </div>
    {% endif %}
    {% endif %}

    {# --- Regular Season standings --- #}
    {% if standings %}
    <div class="section-title-bar"{% if has_bracket %} style="margin-top: 1rem;"{% endif %}>
      <span class="section-title-text">{% if has_bracket %}Regular Season{% else %}Standings{% endif %}</span>
    </div>
    <div class="mini-standings">
      {% for s in standings %}
      <a href="/teams/{{ s.team_id }}" class="ms-row">
        <span class="ms-rank">{{ loop.index }}</span>
        <span class="ms-dot tc-dot" style="--tc: {{ s.color|default('#888') }};"></span>
        <span class="ms-name">{{ s.team_name }}</span>
        <span class="ms-record mono">{{ s.wins }}-{{ s.losses }}</span>
        {% set diff = s.points_for - s.points_against %}
        <span class="ms-diff mono {% if diff > 0 %}diff-positive{% elif diff < 0 %}diff-negative{% endif %}">
          {{ '+' if diff > 0 else '' }}{{ diff }}
        </span>
        {% if streaks is defined and not has_bracket %}
        {% set streak = streaks.get(s.team_id, 0) %}
        {% if streak > 0 %}
        <span class="mono diff-positive" style="font-size:0.75rem; min-width:2rem; text-align:right;">W{{ streak }}</span>
        {% elif streak < 0 %}
        <span class="mono diff-negative" style="font-size:0.75rem; min-width:2rem; text-align:right;">L{{ streak|abs }}</span>
        {% endif %}
        {% endif %}
      </a>
      {% endfor %}
    </div>
    {% endif %}
    <div class="section-more">
      <a href="/standings" class="more-link">Full standings &rarr;</a>
    </div>
  </div>
  {% endif %}

  {# The Floor #}
  {% if post_gov_report %}
  <div class="home-section">
    <div class="section-title-bar">
      <span class="section-title-text">The Floor</span>
      <span class="section-title-badge">Round {{ current_round }}</span>
    </div>
    <div class="home-report">
      <div class="home-report-content">{{ post_gov_report | prose | safe }}</div>
    </div>
    <div class="section-more">
      <a href="/governance" class="more-link">Proposals &amp; votes &rarr;</a>
    </div>
  </div>
  {% endif %}
</div>
{% endif %}

{# ===== UPCOMING ===== #}
{% if upcoming_rounds %}
<div class="home-section">
  <div class="section-title-bar">
    <span class="section-title-text">Coming Up</span>
  </div>
  {% for slot in upcoming_rounds %}
  <div class="{% if not loop.first %}mt-1{% endif %}">
    {% if slot.start_time %}
    <div class="uc-round-header">
      {{ slot.start_time }}
    </div>
    {% endif %}
    <div class="upcoming-strip">
      {% for game in slot.games %}
      <div class="upcoming-card">
        <div class="uc-team">
          <span class="sc-dot tc-dot" style="--tc: {{ game.home_color }};"></span>
          <span>{{ game.home_name }}</span>
        </div>
        <span class="uc-vs">vs</span>
        <div class="uc-team">
          <span class="sc-dot tc-dot" style="--tc: {{ game.away_color }};"></span>
          <span>{{ game.away_name }}</span>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

{# ===== HOW IT WORKS ===== #}
<div class="home-section">
  <div class="section-title-bar">
    <span class="section-title-text">How It Works</span>
  </div>
  <div class="how-grid">
    <div class="how-card">
      <div class="how-number" style="color:var(--accent-highlight);">01</div>
      <h4 class="how-title">Games Play Out</h4>
      <p class="how-desc">3v3 basketball with unique hoopers, special moves, stamina, and an Elam Ending. Every game runs automatically.</p>
    </div>
    <div class="how-card">
      <div class="how-number" style="color:var(--accent-governance);">02</div>
      <h4 class="how-title">You Rewrite the Rules</h4>
      <p class="how-desc">Propose changes in plain English. Vote with your team. Passed proposals reshape the game.</p>
    </div>
    <div class="how-card">
      <div class="how-number" style="color:var(--accent-report);">03</div>
      <h4 class="how-title">The Reporter</h4>
      <p class="how-desc">After every round, the AI surfaces patterns and dynamics you can't see from inside the system.</p>
    </div>
    <div class="how-card">
      <div class="how-number" style="color:var(--accent-score);">04</div>
      <h4 class="how-title">The Game Evolves</h4>
      <p class="how-desc">The league becomes whatever its players decide it should be.</p>
    </div>
  </div>
  <div class="section-more">
    <a href="/play" class="more-link">How to play &rarr;</a>
  </div>
</div>

{# ===== JOIN CTA ===== #}
<div class="home-join-cta">
  <div class="home-join-inner">
    <h3 class="home-join-title">Want to play?</h3>
    <p class="home-join-desc">
      Join the Discord, pick a team, and start rewriting the rules.
      Games run automatically &mdash; the next time the Floor opens is your
      chance to shape the league.
    </p>
    <div class="home-join-actions">
      {% if discord_invite_url %}
      <a href="{{ discord_invite_url }}" class="play-join-btn" target="_blank" rel="noopener">
        Join the Discord
      </a>
      {% endif %}
      <a href="/play" class="home-join-learn">Learn how to play &rarr;</a>
    </div>
  </div>
</div>

{# ===== EXPLORE ===== #}
<div class="home-section">
  <div class="section-title-bar">
    <span class="section-title-text">Explore</span>
  </div>
  <div class="explore-grid">
    <a href="/arena" class="explore-card">
      <span class="explore-icon" style="color:var(--accent-highlight);">&#9654;</span>
      <span class="explore-label">Arena</span>
      <span class="explore-desc">Every game, every play</span>
    </a>
    <a href="/governance" class="explore-card">
      <span class="explore-icon" style="color:var(--accent-governance);">&#9878;</span>
      <span class="explore-label">The Floor</span>
      <span class="explore-desc">Proposals &amp; votes</span>
    </a>
    <a href="/rules" class="explore-card">
      <span class="explore-icon" style="color:var(--accent-elam);">&#9881;</span>
      <span class="explore-label">Rules</span>
      <span class="explore-desc">Current parameters</span>
    </a>
    <a href="/reports" class="explore-card">
      <span class="explore-icon" style="color:var(--accent-report);">&#10070;</span>
      <span class="explore-label">Reports</span>
      <span class="explore-desc">AI reflections</span>
    </a>
  </div>
</div>

{% if not standings and not latest_round_games %}
{# Empty state for brand-new league #}
<div class="empty-state">
  <h3>The season hasn't started yet.</h3>
  <p>Games will appear here once the first round is played.</p>
</div>
{% endif %}
{% endblock %}
